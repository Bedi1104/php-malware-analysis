# chat.pl - reconnaisance and dropper

Native Perl versions of DNS lookup and SMTP email sending.

## Origin

### IP Address

Right now, 87.106.242.16 is in 87.106.0.0/16AS8560. That looks like
a 1&1 German subsidiary, in Karlsruhe, Germany.

DNS says 87.106.242.16 is s15316012.onlinehome-server.info

`whois onlinehome-server.info` gives 1&1 Internet Inc. as admin, registrant and billing contacts.

### Download

Downloaded to a honey pot WSO web shell. The downloader wanted to
execute the "Php" action that WSO provides, which is immediate eval of
PHP code, with no file created. The code downloaded does create a file
in which to store the Perl payload, but it deletes that file as soon
as it can.

## Decoding

1. Hand edit `87.106.242.16WjPLrzyjMixMC240GgLqBAAAAAo.php.file` into `dc1.php` to decode the Base64-encoded block of text.
2. Execute `php dc1.php > chat.pl`

Downloaded a PHP program to a PHP program,
that creates a Perl program, which drops another Perl program.

## Analysis

There's at least 3 things that could be analyzed:

1. PHP dropper
2. Perl server (`chat.pl`)
3. Perl persistent payload

### PHP dropper

The dropper program, the PHP program fed to WSO's "Php" action,
contains a hard-coded URL for my honey pot.
The attacker must recode everything for every compromised WordPress site.

The PHP dropper code goes to enormous effort to get `chat.pl` executing.
It composes two commands:

    $i1="chmod +x $t && /usr/bin/perl $t";
    $i2="chmod +x $t && perl $t";

Then tries to execute these commands using PHP built-ins
`system()`, `exec()`, 'passthru()`, `shell_exec()`, `popen()` and `proc_open()`,
stopping on the first success. `$t` holds the fully qualified path to `chat.pl`.
I expect that the `$i2` command is to execute the `chat.pl` intermediate
on Windows - `/usr/bin` is almost certainly in any Linux PATH.

### chat.pl server

It looks like `chat.pl` can work under Linux, FreeBSD and "MSWin32".
The Linux and FreeBSD specific code seems appropriate.
I can't speak to the quality of the Windows-specific code.

The `chat.pl` program seems like a decently written Perl
server. It does smart server things like change directory to
"/", the root of the filesystem,
it ignores signals like HUP, INT, QUIT, etc,
that Linux/Unix server processes should ignore.
and re-opens STDIN, STDOUT and STDERR as /dev/null.
It forks and sets a session ID, to detach itself from any TTY.

The code is of uniform style and quality. It does `use strict;`
which is wise for Perl programs.
Variables and functions are consistently named in all lower-case.
Functions are called old school style, i.e. `&startserver();`,
with a leading ampersand.

Whoever wrote it was something of a Perl master:
used `sysread()`, `syswrite()`, raw system calls on sockets.
The author sused `pack()` to create,
and then `unpack()` to read, binary-formatted DNS packets.

It does a complicated, interwoven test on
11 IP addresses,
3 TCP protocols (SMTP, DNS, HTTP)
and one UDP protocol (DNS).

|IP Address|DNS Name|Port|Protocol|
|----------|--------|----|--------|
|216.146.43.70|checkip.dyndns.com|TCP/80|HTTP|
|77.88.55.60|yandex.ru|TCP/80|HTTP|
|65.55.92.184|mx1.hotmail.com|TCP/25|SMTP|
|152.163.0.100|mailin-05.mail.aol.com|TCP/25|SMTP|
|98.138.112.38|Yahoo owns it|TCP/25|SMTP|
|205.188.157.232|dns-01.ns.aol.com|TCP/53|DNS|
|205.188.157.232|dns-02.ns.aol.com|TCP/53|DNS|
|205.188.157.232|dns-01.ns.aol.com|UDP/53|DNS|
|205.188.157.232|dns-02.ns.aol.com|UDP/53|DNS|

`chat.pl` tests for whether it can connect to various
useful services that are almost certainly always up.

If `chat.pl` can't connect to at least one of the SMTP
servers, it exits.

If `chat.pl` can't connect to at least one of the DNS
servers, it sets a variable that will cause it to use
it's own, native Perl, DNS library.

Under Linux or "BSD" `chat.pl` leaves behind another file,
then sets `cron` to execute that file: `*/10 * * * * `
This means execute the payload every 10 minutes.

`chat.pl` creates two randomly named files in  `/var/tmp`
or `/tmp`, something like:

    /var/tmp/XPVPxdRrg
    /var/tmp/XPVPxdRrg1

The first file name will end up containing obfuscated code
for a persistent payload.
The second file name will contain the crontab entry,
and gets unlinked after `crontab` updates with the entry above.

`chat.pl` goes on to server something.
IP Addresses: 77.72.83.83, 77.72.83.84

### The Persistent Payload

#### Decoding the Persistent Payloads

1. Hand-edit `chat.pl`, yielding files `BDRPDATABSD` and `BDRPDATALIN`.
2. Hand edit the "BDRP*" files to use the decoding method from `chat.pl`
3. Invoke: `perl BDRPDATABSD > BDRPDATABSD.out`
4. Invoke: `perl BDRPDATALIN > BDRPDATALIN.out`
5. Invoke: `perl BDRPDATABSD.out > BDRPDATABSD.out.out`
6. Invoke: `perl BDRPDATALIN.out > BDRPDATALIN.out.out`
7. Use `perltidy` on `BDRPDATALIN.out.out` and `BDRPDATABSD.out.out` to increase readability.

Files `BDRPDATABSD.out` and `BDRPDATALIN.out` are more Perl code
obfuscated with the same method
as `BDRPDATABSD` and `BDRPDATALIN`, necessitating a second decoding.
The Perl uses `unpack('u*',$', $string)` to do uudecoding,
which is fairly sophisticated.  UUencoded source is pretty old school.

`BDRPDATABSD.out.out.tdy` and `BDRPDATALIN.out.out.tdy` are identical. How bout that?

#### Analysis of Persistent Payload

The persistent payload looks like it has the same author as `chat.pl`,
the code is consistently formatted, variables name in "snake_case",
and the Perl `code if $condition;` construct appears a lot.
The peristent payload also becomes a well-mannered Linux or *BSD
daemon, changing directory to "/", 
forking and setting session ID to detach from any TTY,
ignoring certain signals,
and changing stdin, stdout and stderr to /dev/null.
It's probably overkill for something started by `cron`.

It appears that the payload chooses either 5.135.42.98 or 77.72.83.83,
composes a URI


Is this the mumblehard malware? https://www.welivesecurity.com/wp-content/uploads/2015/04/mumblehard.pdf
`sub xorl` is the same, but the Eset report has a different
delivery method, involving an ELF file unpacker.

http://hardwarefetish.com/681-mumblehard-c-trojan-unpacked
https://detux.org/report.php?sha256=a4199f2a1539f0e9b5d18b81873ad65f332046b2a1c4f7e44b039fd93e369c87

