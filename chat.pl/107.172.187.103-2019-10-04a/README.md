# Mumblehard download via WSO 4.x

Download of evolved Mumblehard botnet code via an invocation
of WSO 4.x web shell.

## Download

Downloaded to what the attackers thought was a WSO 4.x webshell,
at `/wp-content/themes/sketch/404.php`.
This URL has been used to attempt to download mumblehard in the past,
but it's also been used to try to download a lot of things.

|HTTP Parameter|Value|
|-----------|---------------|
|pass|01ab4704ef113a27b8b5c14092a819c2|
|a|NxAcGg==|
|p1|base64-encoded data|

WSO 4.x series of WSO-family web shells will check an
HTTP parameter with the name "ne",
presumably standing for "not encrypted".
If a parameter named "ne" does not appear,
WSO 4.x series web shells try to decode values of HTTP parameters
named "a", "c", "p1", "p2" and "p3",
using the value of an HTTP parameter named "key"
as the decryption key.
The encoding is simple Xor on base64-encoded cleartext.

The "a" (for "action") parameter value of "NxAcGg==" decodes to "Php".

    echo -n NxAcGg== | base64 -d | ./xor - bWtmaWxl | base64 -d

"pass", "a", "p1" are all stereotypical HTTP parameters for a [WSO web shell](/webshells/wso_in_depth) invocation.
The "a" value of "NxAcGg==" showed up a lot in [honey pot captures](/NxAcGg) in 2017.
I managed to guess the Xor key of "bWtmaWxl" at that time.

## Deobfuscation

    $ base64 -d *php.file > raw.data
    $ ./xor raw.data bWtmaWxl > data2
    $ base64 -d data2 > raw2

## Dropper

[PHP dropper](raw2) checks the value of PHP's well-known value "PHP_OS".
It this indicates a Windows host, it exits, returning the string "b3dsht7d=windows=".
The dropped code is apparently intended only to run on non-Windows machines.
I approve.
The dropper base64-decodes a long embedded string,
which produces Perl with an embedded [uuencoded](https://en.wikipedia.org/wiki/Uuencoding) string.
[The perl](dc2.pl) decodes the embedded string into [executable perl code](dc3.pl),
then eval's it.
It looks like the dropper writes the perl code to a pipe
that's the Perl interpreter's stdin.
The perl code never appears as a disk file,
or at least no place a user would be able to find it.

The dropper seems to respond to its invoker with strings
like 'b3dsht7d' on a failure, and 'g0udht7d=Jm73uZ'.
These might correspond to "bedshitted" on a failure, and "good" something on success.
The mumblehard Perl code seems to also use "Jm73uZ" as a success indicator.

## Mumblehard

The mumble hard code has evolved somewhat since my [last look](/chat.pl).
It appears to have retained all the same capabilities,
but small things have changed.
Functions have been renamed: "main" becomes "set_m", "init" becomes "set_i",
"test" becomes "t_est.
There are more checks to keep it from executing on  Windows hosts,
constants have been obscured,
it does not have embedded, encoded code for a BSD and a Linux
variant of the [cron job](drdata), only a Linux version.
Variable names have changed.
It's more cautious about writing out the cron job code:
it writes and removes a test file before writing out the cron job
code and trying to get it accepted as a crontab entry.

The [cron job code](drdata.decoded) appears to have only been given
cosmetic upgrades and minor bug fixes.
