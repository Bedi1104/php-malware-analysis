#!/bin/bash
rm -rf payloads
mkdir payloads
for IP in 192.185.4.87 162.241.244.141 50.87.248.201 192.185.2.118 210.211.125.204 69.195.124.155
do
	fgrep '$payload_file = ' $(echo files/${IP}*scans) | sort | uniq > payloads/$IP
done

rm -rf intermediate1
mkdir intermediate1
for FNAME in payloads/*
do
	BN=$(basename $FNAME)
	DST=intermediate1/$BN
	echo '<?php ' > $DST
	cat $FNAME >> $DST
	echo 'print(rawurldecode($payload_file));' >> $DST
done

rm -rf intermediate2
mkdir intermediate2
for FNAME in intermediate1/*
do
	BN=$(basename $FNAME)
	DST=intermediate2/$BN
	echo '<?php' > $DST
	php $FNAME >> $DST
done

rm -rf deobfuscated
mkdir deobfuscated
for FNAME in intermediate2/*
do
	BN=$(basename $FNAME)
	DST=deobfuscated/$BN
	echo '<?php' > $DST
	$HOME/src/php/reverse-php-malware/revphp $FNAME > $DST
done
