# Web Shell with a kink

Web Shell by oRb (WSO) version 2.5 with a blob of added code.

## Origin

### IP Address 18.222.103.133

Amazon AWS instance, not worth following up on.

`p0f3` says it's "Windows 7 or 8":

    [2018/03/17 14:00:59] mod=syn|cli=18.222.103.133/50472|srv=162.246.45.144/80|subj=cli|os=Windows 7 or 8|dist=19|params=fuzzy|raw_sig=4:109+19:0:1460:8192,8:mss,nop,ws,nop,nop,sok:df,id+,ecn:0
    [2018/03/17 14:00:59] mod=mtu|cli=18.222.103.133/50472|srv=162.246.45.144/80|subj=cli|link=Ethernet or modem|raw_mtu=1500
    [2018/03/17 14:00:59] mod=syn+ack|cli=18.222.103.133/50472|srv=162.246.45.144/80|subj=srv|os=???|dist=0|params=none|raw_sig=4:64+0:0:1460:mss*20,7:mss,nop,nop,sok,nop,ws:df:0

### Download

The attacker wanted to send a file named `customizer-ui-experimenks.zip` via the updaste plugin WordPress
functionality. My WordPress honey pot just saved it. `customizer-ui-experimenks.zip` actually was a Zip-format-file,
containing a file named `customizer-ui-experimenks.php` which has the format "UTF-8 Unicode (with BOM) text",
so it made a trip through one of the stupider Microsoft text editors along the way.

## Decoding

Unzipping `18.222.103.133Wq1z-x2iJJ9Dd7fGpaoj4gAAAAI.0.file`
gives a file `customizer-ui-experimenks.phpcustomizer-ui-experimenks.php`.
Unzipping `18.222.103.133WqvXLekLitkX3G-vql5EDAAAAAQ.0.file`
yields `apache1`, an ELF file, and `customize-partial-refrewh.php`,
more PHP.

### Decode customizer-ui-experimenks.php

1. Hand-edit `customizer-ui-experimenks.php` into `dc1.php`
2. Run [PHP reverse engineering tool]() over `dc1.php` to get `f1.php`.
3. Edit `f1.php` to change "eval" to "print".
4. Invoke `php f1.php > dc2.php`
5. Pretty print `dc2.php` to get `f2.php`, which I think is the final form.

### Decode customize-partial-refrewh.php

1. Hand-edit `customize-partial-refrewh.php` into `bc1.php`
2. Run [PHP reverse engineering tool]() over `bc1.php` to get `bc2.php`.
3. Edit `bc2.php` to change "eval" to "print".
4. Invoke `php bc2.php > bc3.php`
5. Pretty print `bc3.php` to get `bc4.php`

The original source for `f2.php` and `bc4.php` got obfuscated
by a program. The obfuscation was quite similar. Base64-encoded
gzip's of PHP source code with line feeds removed, and a
small decoding program get appended to a PHP comment. The
variable names in the decoding programs differ, but neither
decoding program has names a human would use.

## Analysis

When called with a HTTP POST parameter named "tc", the extra, non-standard-WSO
blob of code ends up taking a timestamp from "../../languages". If that doesn't
exist, it takes a random timestamp between Saturday, January 30, 2016 9:38:44 PM GMT-07:00 
and Monday, January 30, 2017 9:38:44 PM GMT-07:00.
The code then finds all files at or below the current directory, and 
changes the last-accessed timestamp of all those files to whatever timestamp
it initially came up with. I'm guessing this is to hide the presence of
`customizer-ui-experimenks.php` from human eyes by making all timestamps
the same: it won't show up in `ls -ltr` as glaringly.


18.222.103.133 - - [16/Mar/2018:08:39:37 -0600] "GET /wp-login.php HTTP/1.1" 200 3007 "https://www.google.com" "Mozilla/5.0 (Windows NT 6.1; rv:29.0) Gecko/20120101 Firefox/29.0"
18.222.103.133 - - [16/Mar/2018:08:39:37 -0600] "POST /wp-login.php HTTP/1.1" 302 - "https://www.google.com" "Mozilla/5.0 (Windows NT 6.1; rv:29.0) Gecko/20120101 Firefox/29.0"
18.222.103.133 - - [16/Mar/2018:08:39:37 -0600] "GET /wp-admin/ HTTP/1.1" 200 41033 "https://www.google.com" "Mozilla/5.0 (Windows NT 6.1; rv:29.0) Gecko/20120101 Firefox/29.0"
18.222.103.133 - - [16/Mar/2018:08:39:37 -0600] "GET /wp-admin/plugins.php HTTP/1.1" 200 34427 "http://stratigery.com/wp-admin/index.php" "Mozilla/5.0 (Windows NT 6.1; rv:29.0) Gecko/20120101 Firefox/29.0"
18.222.103.133 - - [16/Mar/2018:08:39:38 -0600] "GET /wp-admin/plugin-install.php HTTP/1.1" 200 22945 "http://stratigery.com/wp-admin/plugins.php" "Mozilla/5.0 (Windows NT 6.1; rv:29.0) Gecko/20120101 Firefox/29.0"
18.222.103.133 - - [16/Mar/2018:08:39:39 -0600] "GET /wp-admin/plugin-install.php?tab=upload HTTP/1.1" 200 22578 "http://stratigery.com/wp-admin/plugin-install.php" "Mozilla/5.0 (Windows NT 6.1; rv:29.0) Gecko/20120101 Firefox/29.0"
18.222.103.133 - - [16/Mar/2018:08:39:41 -0600] "POST /wp-admin/update.php?action=upload-plugin HTTP/1.1" 200 16347 "http://stratigery.com/wp-admin/plugin-install.php" "Mozilla/5.0 (Windows NT 6.1; rv:29.0) Gecko/20120101 Firefox/29.0"
18.222.103.133 - - [16/Mar/2018:08:39:45 -0600] "GET /wp-content/plugins/customize-partial-refrewh/customize-partial-refrewh.php HTTP/1.1" 200 120 "-" "-"
18.222.103.133 - - [17/Mar/2018:14:00:59 -0600] "GET /wp-login.php HTTP/1.1" 200 3007 "https://www.google.com" "Mozilla/5.0 (Windows NT 6.2; rv:33.0) Gecko/20100101 Firefox/33.0"
18.222.103.133 - - [17/Mar/2018:14:00:59 -0600] "POST /wp-login.php HTTP/1.1" 302 - "https://www.google.com" "Mozilla/5.0 (Windows NT 6.2; rv:33.0) Gecko/20100101 Firefox/33.0"
18.222.103.133 - - [17/Mar/2018:14:01:00 -0600] "GET /wp-admin/ HTTP/1.1" 200 41033 "https://www.google.com" "Mozilla/5.0 (Windows NT 6.2; rv:33.0) Gecko/20100101 Firefox/33.0"
18.222.103.133 - - [17/Mar/2018:14:01:00 -0600] "GET /wp-admin/plugins.php HTTP/1.1" 200 34427 "http://stratigery.com/wp-admin/index.php" "Mozilla/5.0 (Windows NT 6.2; rv:33.0) Gecko/20100101 Firefox/33.0"
18.222.103.133 - - [17/Mar/2018:14:01:00 -0600] "GET /wp-admin/plugin-install.php HTTP/1.1" 200 22945 "http://stratigery.com/wp-admin/plugins.php" "Mozilla/5.0 (Windows NT 6.2; rv:33.0) Gecko/20100101 Firefox/33.0"
18.222.103.133 - - [17/Mar/2018:14:01:01 -0600] "GET /wp-admin/plugin-install.php?tab=upload HTTP/1.1" 200 22578 "http://stratigery.com/wp-admin/plugin-install.php" "Mozilla/5.0 (Windows NT 6.2; rv:33.0) Gecko/20100101 Firefox/33.0"
18.222.103.133 - - [17/Mar/2018:14:01:03 -0600] "POST /wp-admin/update.php?action=upload-plugin HTTP/1.1" 200 16347 "http://stratigery.com/wp-admin/plugin-install.php" "Mozilla/5.0 (Windows NT 6.2; rv:33.0) Gecko/20100101 Firefox/33.0"
18.222.103.133 - - [17/Mar/2018:14:01:06 -0600] "POST /wp-content/plugins/customizer-ui-experimenks/customizer-ui-experimenks.php HTTP/1.1" 200 120 "-" "-"
18.222.103.133 - - [17/Mar/2018:14:01:07 -0600] "POST /wp-content/plugins/customizer-ui-experimenks/customizer-ui-experimenks.php HTTP/1.1" 200 13743 "-" "-"
