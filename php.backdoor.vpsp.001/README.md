# gate.php - backdoor

A little googling says this code is [php.backdoor.vpsp.001](https://kb.sucuri.net/malware/signatures/php.backdoor.vpsp.001)

## Origin

### IP Address 2.134.166.36

2.134.166.36 has no DNS name associated.

`whois` has this as assigned to Kazahktelecom:

Information related to '2.134.164.0/22AS9198'

    route:          2.134.164.0/22
    descr:          Kazakhtelecom Data Network Administration
    origin:         AS9198
    mnt-by:         KNIC-MNT
    created:        2012-01-26T11:03:51Z
    last-modified:  2012-01-26T11:03:51Z
    source:         RIPE

More specifically, in Shymkent:

    inetnum:        2.134.160.0 - 2.134.191.255
    netname:        SHYMMETRO
    descr:          JSC Kazakhtelecom, South Kazakhstan Affiliate
    descr:          Metro Ethernet Network
    descr:          Shymkent
    country:        KZ

`geoiplookup.net` agrees about Shymkent. I'd never heard of Shymkent before.

`p0f3` claims it's running Windows XP, `nmap` says all its ports are filtered, doesn't want to guess.


### Download

Downloader thought that someone had prevsiously  installed a WSO web shell in
my WordPress honey pot. They downloaded PHP "dropper" code with a base64-encoded
PHP payload.

The downloader set the dropper code to the "Php" action of WSO, which is a common
choice of bottom feeders. The "Php" action evaluates any PHP sent to it immediately.
WSO does complicate things by sending back all the HTML of the 
, so the downloader would have to sort out any dropper code output.

## Decoding

1. Hand edit `2.134.166.36Wm2uPZMiv3KFp8vNizZazQAAAAkfile` into `dc1.php`, which amounts to
removing the dropper code that finds a random, writeable directory.
2. Invoke `php dc1.php`, which produces `gate.php`
3. Pretty print `gate.php` to get `f1.php`

`gate.php` appears to be the code's final form. It comprises a single 
string of PHP code, having no end-of-line characters at all. Visually
obscured, necessitating the final pretty printing for readability.

## Analysis

### Dropper

The dropper code shows up commonly. It drops a variety of malware. The dropper
only uses 1 PHP "superglobal, `$_SERVER['DOCUMENT_ROOT'`.  Stylistically, it's
pretty even. Functions and variables are in camelCase, function begin with an
upper case letter (`GetAllDirs`, `GetRandomPath`), variables all begin with a
lower case letter (`$alldirs`, `$fileWritePath`). It's reasonably well
structured - there's an effort to separate main flow-of-control from details,
which get put in functions. The author indented the code reasonably consistently:
there are 2 unindented lines in `function FileWrite`.
It's tab-indened, except for the last 4 lines of
code in the dropper, which have tabs and spaces, perhaps indicating mods by a
second author. It has MS-DOS (carriage-return linee-feed) line endings, except
for the first 3 lines of the file, which again maybe indicate mods by a second
author.
