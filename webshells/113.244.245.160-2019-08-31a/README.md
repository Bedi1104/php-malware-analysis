# WSO 2.4 web shell

Another somewhat-modified WSO web shell,
which would be put in place by an immediate eval backdoor.

It's actually a modified WSO 2.5 web shell.
These particular hackers didn't respect the WSO version numbering
that's floating around out there.

## Origin

This appears to have a desired destination of
an immediate evaluation backdoor
that uses an HTTP parameter named "dd" to hold the code.

The [Python password guesser](/120.229.163.49-2018-10-28a)
relies on a similar backdoor.
It was also downloaded from a Chinese IP address,
but that probably doesn't matter.

The immediately-evaluated code would have dropped a file,
then returned a string `->|1|<-` if it worked, or `->|0|<-` if it did not actually drop the malware.

### IP Address 113.244.245.160

113.244.245.160 has no DNS name.
It belongs to Chinanet:

    inetnum:        113.240.0.0 - 113.247.255.255
    netname:        CHINANET-HN
    descr:          CHINANET HUNAN PROVINCE NETWORK
    descr:          China Telecom
    descr:          No.31,jingrong street
    descr:          Beijing 100032

## Deobfuscation

### Deobfuscation of dropper

1. Convert the [captured HTTP parameters](113.244.245.160XWpgPTBgmLwp8u4CRNGbPAAAAAc.wso.scans) to PHP, resulting in [dc1.php](dc1.php)
2. Run `dc1.php`, which decodes the Base64-encoded string that the backdoor would eval, resulting in [dc2.php](dc2.php).
This constitutes the "dropper" code.
3. Reformat the [dropper code](dc2.php) for readability, yielding [dc3.php](dc3.php).
4. Edit the [more-readable dropper](dc3.php) to print out the file name that would have contained dropped code.
The dropped file name is `SCRIPT_FILENAMEZ:://xx.php`.
This won't work as a Linux file name unless a directory named `SCRIPT_FILENAMEZ::`
already exists. I chose `xx.php` as the file name. The file [xx.php](xx.php) contains the file so created.

I'm not a Windows person at all, but I think"SCRIPT_FILENAMEZ:://xx.php" won't work
as a Windows file name at all: they're not supposed to have embedded ':' or '/' characters.
I don't think the dropper will work as written.

File `xx.php` has a comment `/*** WebShellOrb 2.6 - With PHP 7 ***/` which
would seem to indicate it's an instance of Web Shell by oRb.
It contains obfuscated PHP code.
Let's deobfuscate it.

### Deobfuscation, level 2

1. Reformat [xx.php](xx.php) into [dc4.php](dc4.php).
Reformat `dc4.php` into [dc5.php](dc5.php).
2. `dc5.php` contains 3 eval's of base64-encoded PHP.
I broke them out into seperate files for ease of manipulation.
  1. [e1.php](e1.php) defines a `function YiunIUY76bBhuhNYIO8()`
  which apparently takes a substring of an input string.
  2. [e2.php](e2.php) defines `function ZsldkfhGYU87iyihdfsow()`
  taking 2 strings as format arguments. If the `sha1()` hash of the 
  first argument equates to the value of the second argument,
  `function ZsldkfhGYU87iyihdfsow()` base64-decodes and gzinflates
  the first argument. Otherwise, it considers the file corrupt.
  3. [e3.php](e3.php) decodes to an invocation of `ZsldkfhGYU87iyihdfsow()`
  using the results of 2 calls to `function YiunIUY76bBhuhNYIO8()` as arguments.
I modified file `dc5.php` to have un-encoded versions of the 3 evals.
3. Run `dc5.php` to get [dc6.php](dc6.php),
a file full of PHP obscured using one of many text representations PHP allows,
plus some goofy use of `$GLOBALS` superglobal.

### Deobfuscation, level 3

1. Run `dc6.php` through a pretty-printer to get [dc7.php](dc7.php)

File `dc7.php` has some regrettably complex uses of PHP's `GLOBALS`
that don't lend themselves to easy deobfuscation.
As an example:

    line  65  ${"GLOBALS"}["vvdxmjbgec"] = "v";
    line  67  ${"GLOBALS"}["fskqowyovpk"] = "m";
    line  89  ${"GLOBALS"}["oqvryxe"] = "k";
    line 267  ${${"GLOBALS"}["fskqowyovpk"]} = array("Sec. Info" => "SecInfo", "Files" => "FilesMan", ...
    line 274  foreach (${${"GLOBALS"}["fskqowyovpk"]} as ${${"GLOBALS"}["oqvryxe"]} => ${${"GLOBALS"}["vvdxmjbgec"]}) 

So line 274 of `dc7.php` might originally have looked like this:

    foreach ($m as $k => $v)

I'm going to stop here. I'm not sure how to deobfuscate this further.

## Analysis

The first big question: is this really WSO 2.6?
As if by magic, a large number of versions of WSO circulate,
but the versioning almost always stays consistent.
That is, there aren't multiple divergent evolutionary paths
that end up as version X.Y.
For some reason, people seem to respect WSO versioning.
oRb seems to have done corporate-style development and bug
fixing from 2.0 to 2.5, but after that, chaos has ensued.

Other instances of WSO labeled as 2.6 descended from oRb's
original 2.4, which kept state in a PHP session on the compromised host.
This code does not: it uses a cookie or cookies,
which end up on the attacker's machine, to store the state.

This code has `function WebShellOrbsetcookie`:

    function WebShellOrbsetcookie($k, $v)
    {
        ${"GLOBALS"}["inbcfdml"] = "k";
        $gltqybwss = "v";
        $_COOKIE[${${"GLOBALS"}["inbcfdml"]}] = ${$gltqybwss};
        ${"GLOBALS"}["liyrzggwi"] = "v";
        setcookie(${${"GLOBALS"}["oqvryxe"]}, ${${"GLOBALS"}["liyrzggwi"]});
    }

Code from a clean WSO 2.5 looks like this:

    function WSOsetcookie($k, $v)
    {
        $_COOKIE[$k] = $v;
        setcookie($k, $v);
    }

There's an obvious correspondence.
We can dispense with any further attempts at linking this
to other WSO version 2.6 code floating around:
it descends from oRb's WSO_VERSION 2.5

Comparing occurances of string literal "function action"
in [this code](dc7.php) with WSO 2.5 code,
it appears that the modifiers of this code deleted
`function actionRC`,
one of the 12 or so main "actions" that one can invoke of a WSO instance.

`actionRC` is combination of an immediate eval backdoor,
and a reconnaissance function.
Even though it's rather widely invoked on WSO instances,
it really doesn't fit with WSO's main emphasis on interactive use by humans.

Beyond the complicated use of the `GLOBALS` superglobal,
this WSO code has modified function names.
Where the origial WSO 2.5 had a mix of function names
like `WSOstripslashes`, `wsoLogin`, `wsoHeader`, `WSOsetcookie`,
this code has `WebShellOrbstripslashes`,
`WebShellOrbLogin`, `WebShellOrbsetcookie`, `WebShellOrbHeader`.
The modifying auther changed both "WSO" and "wso" prefixes of
function names to "WebShellOrb".

I judge that some code transformations are performed on
this author's code to produce the partially deobfuscated code
I ended up with.
The transformed code gets packaged to work with the dropper.
The packaging includes making `function YiunIUY76bBhuhNYIO8`,
which extracts 3 different pieces of Base64-encoded text from the dropper itself.
