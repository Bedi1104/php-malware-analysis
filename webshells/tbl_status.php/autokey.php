<?php
/*
 * autokey test
 * Doesn't MD5-hash the key like this malware does
 */

$str = $argv[1];
$key = $argv[2];

$encoded = autokey_decode($str, $key);
$decoded = autokey_encode($encoded, $key);
print $decoded."\n";

function autokey_decode($ciphertext, $key) {
	$max = strlen($ciphertext);
	$encoded = '';
	for ($i = 0; $i < $max; ++$i) {
		$b = $ciphertext[$i];
		$o = ord($b);
		$k = ord($key[$i]);
		$c = chr(($o - $k)%256);
		$key .= $c;
		$encoded .= $c;
	}
	return $encoded;
}

function autokey_encode($cleartext, $key) {
	$max = strlen($cleartext);
	$ciphertext = '';
	for ($i = 0; $i < $max; ++$i) {
		$b = $cleartext[$i];
		$o = ord($b);
		$k = ord($key[$i]);
		$e = chr(($o + $k)%256);
		$key .= $b; // Need to use cleartext byte here
		$ciphertext .= $e;
	}
	return $ciphertext;
}
