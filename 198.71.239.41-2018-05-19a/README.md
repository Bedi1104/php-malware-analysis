# Vigilante Malware Cleaner

*2018-05-22*

PHP downloaded to WSO web shell's "RC" action for immediate eval
that finds 56 different indications of PHP malware,
counts those indications,
returning the counts to the invoker.
It renames any file containing an indication of PHP malware.

Because it renames the files it finds malware indications in,
I imagine the authors/invokers consider themselves good guys:
they can find out what malware is installed,
and they can effectively neutralize that malware.

I found an [older capture](198.71.239.32-2018-02-26a)
after I finished this analysis.
See that directory for analysis of any changes in the last 3 months.

## Origin

### IP Address 198.72.239.41

198.72.239.41 has DNS name a2nlwpweb040.prod.iad2.secureserver.net

It's owned by GoDaddy.

a2nlwpweb040.prod.iad2.secureserver.net has IP address 198.71.239.41 in DNS.

secureserver.net is owned by GoDaddy.

### Download

Looks like the attacker thought they were sending code to a WSO web shell.
They wanted to use WSO's "RC" action, which immediately eval's
any PHP code that arrives in the 'p1' HTTP POST parameter.

They thought that WSO was at `/wp-content/themes/sketch/404.php`.
That's a pretty common place for someone to hide WSO.
People download the "sketch" theme to my WordPress honey pot frequently.

## Analysis

The downloaded code consists of an unencoded portion,
a base64-encoded set of function definitions,
and a serialized, base64-encoded array-of-arrays.

### Unencoded portion

This looks a lot like boilerplate code for a program
dropper that's used to install a variety of PHP malware.
The [Code-in-cookie back door](../212.54.205.145-2018-01-25a)
has an almost exact copy of the `GetDocRoot()` function,
and the back door's `GetDirectoryList()` is clearly the
ancestor of this code's `GetFileList()` function.

Between functions `GetDocRoot()` and `GetFileList()`,
the code produces a list of files,
probably all files under Apache's DocumentRoot directory.
Circumstances exist where some subdirectory of Apache's
DocumentRoot or even "/"
(the root of the filesystem) might be used.

### Set of function definitions

The code creates 112 oddly-named functions
via the old favorite `eval(base64_decode())` function
composition.
Half (56) of the functions have an argument named `$path`,
the other half have an argument named `$content`.
The 56 functions with an argument named `$path` 
are identical except for the function name.
As an example:

    function gzfkylyosi($path)
    {
        if (!@rename($path, $path . ".suspected")) {
            @unlink($path);
        }
    }

All these 56 functions either rename a file to have
".suspected" as a suffix,
or they delete the file.

The other 56 functions,
all having one formal argument named `$content`,
check for the presence of various strings.
These functions vary in complexity,
but a typical function looks like this:

    function rzbvtgkg($content)
    {
        if (strpos($content, "b374k 2.8") !== FALSE) {
            return TRUE;
        }
        return FALSE;
    }

It appears that each of the 56 `$content` functions
looks for a string or strings that appear in a particular PHP malware.
The above function clearly returns TRUE if it finds a
[b374k]() web shell.

### Serialized array-of-arrays

Once base64-decoded and unserialized,
the array-of-arrays named `$defs` contains entries like this:

    {15, "rtob", "gfjsi"}

There are 56 of these entries.
Each string in the entry matches the name of a function.
For the entry above:

    function rtob($content)
    {
        if (strpos($content, "if(mail(\$MailTo,") !== FALSE) {
            if (substr_count($content, ")") == 14) {
                return TRUE;
            }
        }
        return FALSE;
    }
    function gfjsi($path)
    {
        if (!@rename($path, $path . ".suspected")) {
            @unlink($path);
        }
    }

One function to identify a file that might or probably
contains PHP malware code,
and one function to rename the file to "file.suspected".

Interestingly, the 0-element of the entries are not
numbered consecutively, running from 2 to 198.
Did more signatures appear in previous 
versions of this code in the past?

The three parts of this malware look
for "signatures" of other PHP malware,
then renames the files found.
It counts the number of each signature it finds,
and prints out a base64-encoded serialization of the array of counts of signatures.
That's clearly a machine-readable summary of what it found.

## Some malware that it will rename if found

* WSO 2.5, 2.5.1, 2.8, 3.1 web shells
* Most other WSO web shell variants
* [b374k web shell](../b374k_3.2.3.php), but only v2.8
* Anything FOPO-encoded
* [nptzow](../nptzow)
* Itself, but it's careful to not count itself twice
* JavaScript from "Ayildiz Tim" Turkish hackers' HTML
* Anything with the string '<?php @eval($_POST[', which should catch a lot of the 1-liner backdoors in WordPress themes or plugins
* Anything with the string `eval(gzinflate(base64_decode(`, which catches a lot of droppers
* Anything with a URL that [Spam Blocklist Recon malware](../36.65.41.151-2018-05-04a) often uses
* 45 others that I don't recognize

## ".suspected" URLs accessed

I have Apache `access_log` files in "combined" format dating back to 2009.
It looks like URIs with a ".suspected" suffix have shown up in the past,
the earliest from 2016

    2016-04-12 03:51:10-06 | 178.151.184.223 | /wp-content/plugins/wp-arm-config/antibot.php.suspected

Bizarrely, some URLs I found in my logs have a ".suspected_" suffix, perhaps another layer of moving the code around.

I don't understand accessing those URLs,
as Apache/2.4.33 seems to just send any such file's contents,
but without a "Content-type:" header.
Apache doesn't run the PHP interpreter on the URL's contents, so what's the point?
