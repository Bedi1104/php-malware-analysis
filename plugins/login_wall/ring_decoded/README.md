# ring.php - web shell

`ring.php` arrives as part of the [login_wall plugin](/plugins/login_wall).

`ring.php` gets used to download [/gsptg.php], some kind of SEO campaign injector.

### IP Address 192.154.105.154

192.154.105.154 &rarr; 192-154-105-154.static.gorillaservers.com.

192-154-105-154.static.gorillaservers.com does not have an IP address in DNS.

`whois` agrees:

    NetRange:       192.154.96.0 - 192.154.111.255
    CIDR:           192.154.96.0/20
    NetName:        GSI-192-154-96-0
    NetHandle:      NET-192-154-96-0-1
    OriginAS:       AS53850
    Organization:   GorillaServers, Inc. (GORIL-3)
    RegDate:        2012-11-28
    Updated:        2013-01-31

    network:Auth-Area:192.154.96.0/20
    network:ID:NET-11548.192.154.105.152/29
    network:Network-Name:192.154.105.154/29
    network:IP-Network:192.154.105.152/29
    network:IP-Network-Block:192.154.105.152 - 192.154.105.159

### Download

`ring.php` arrives as one file of many in the [login_wall plugin](/plugins/login_wall).
The attackers would believe that they downloaded a Zip file
(with whatever extra files a WordPress "plugin" would require) 
via the "install a plugin" WordPress admin page.

Unfortunately, I run a WordPress honey pot that can emulate plugin download and install,
so I captured the Zip file.

## Analysis

`ring.php` doesn't appear particularly like an obfuscated web shell.
It looks like an ordinary, yet esoteric, piece of WordPress code.
It has a comment block that doesn't make sense,
yet references WordPress conventions like "default hooks" and "priority".

The coding style looks WordPress-like as well:
careful `$snake_case` variable and function names,
"wp_" prefixes on variable names.

Some of the variables get what looks like HTML assigned to them.
One of those variables is named `$wp_default_logo`.
It apparently contains one of those in-lined, Base64-encoded PNG images
that some web apps use, apparently to cut down on the large number of files necessary.
The Base64-encoded material is not a PNG format image,
but rather the PHP code for a web shell.
The web shell code is reasonably tightly integrated into the `ring.php` obscuring PHP.
You need to invoke `ring.php` with a special parameter or cookie value to actually
execute the web shell code.
`ring.php` output without "_f_wp" set as a Cookie value or POST parameter is a small HTML form:

    <form method= "post" action= ""> <input type= "input" name= "_f_wp" value= ""/><input type= "submit" value= "&gt;"/></form>

Entering "G0YgIaXqx" and clicking the button shows us `ring.php` as a web shell:

![ring screenshot](ring_screenshot.png?raw=true)

The web shell PHP is compressed via gzip and Xor-encoded with the 9-byte key "G0YgIaXqx".
Gzipping the PHP is a pretty good way to conceal the Xor bytes,
and even makes it hard to guess the Xor byte key length,
since the Zip algorithm removes redundancy from the PHP code, 
and only has small, 3-bit "header" values interspersed throughout the compress data.
I was not clever enough to guess the Xor key.
I had to wait until an attacker tried to invoke `ring.php`.
My honey pot code caught the "_f_wp" parameter's value.
