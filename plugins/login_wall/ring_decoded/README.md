# ring.php - web shell

This code seems to have hijacked the comments, function names and style
of WordPress plugin code,
but turned it into a backdoor.
Googling for the package ID that appears in the code ("64f722503297a845d239")
yields a few hits, all obviously this same file, or a related malware.
Googling for the function signature of `pre_term_name` gets me a [stack overflow](https://stackoverflow.com/questions/44165279/wordpress-vulnerability-issue)
post about this malware.
Looks like it's been around for a while.

It seems to call itself "S.A.P. v2.1"

`ring.php` arrives as part of the [login_wall plugin](/plugins/login_wall).

`ring.php` gets used to download [gsptg.php](/gsptg.php), some kind of SEO campaign injector.

### IP Address 192.154.105.154

192.154.105.154 &rarr; 192-154-105-154.static.gorillaservers.com.

192-154-105-154.static.gorillaservers.com does not have an IP address in DNS.

`whois` agrees:

    NetRange:       192.154.96.0 - 192.154.111.255
    CIDR:           192.154.96.0/20
    NetName:        GSI-192-154-96-0
    NetHandle:      NET-192-154-96-0-1
    OriginAS:       AS53850
    Organization:   GorillaServers, Inc. (GORIL-3)
    RegDate:        2012-11-28
    Updated:        2013-01-31

    network:Auth-Area:192.154.96.0/20
    network:ID:NET-11548.192.154.105.152/29
    network:Network-Name:192.154.105.154/29
    network:IP-Network:192.154.105.152/29
    network:IP-Network-Block:192.154.105.152 - 192.154.105.159

### Download

`ring.php` arrives as one file of many in the [login_wall plugin](/plugins/login_wall).
The attackers would believe that they downloaded a Zip file
(with whatever extra files a WordPress "plugin" would require) 
via the "install a plugin" WordPress admin page.

Unfortunately, I run a WordPress honey pot that can emulate plugin download and install,
so I captured the Zip file.

## Analysis

`ring.php` doesn't appear particularly like an obfuscated web shell.
It looks like an ordinary, yet esoteric, piece of WordPress code.
It has a comment block that doesn't make sense,
yet references WordPress conventions like "default hooks" and "priority".

The coding style looks WordPress-like as well:
careful `$snake_case` variable and function names,
"wp_" prefixes on variable names.

Some of the variables get what looks like HTML assigned to them.
One of those variables is named `$wp_default_logo`.
It apparently contains one of those in-lined, Base64-encoded PNG images
that some web apps use, apparently to cut down on the large number of files necessary.
The Base64-encoded material is not a PNG format image,
but rather the PHP code for a web shell.
The web shell code is reasonably tightly integrated into the `ring.php` obscuring PHP.
You need to invoke `ring.php` with a special parameter or cookie value to actually
execute the web shell code.
`ring.php` output without "_f_wp" set as a Cookie value or POST parameter is a small HTML form:

    <form method= "post" action= ""> <input type= "input" name= "_f_wp" value= ""/><input type= "submit" value= "&gt;"/></form>

Entering "G0YgIaXqx" and clicking the button shows us `ring.php` as a web shell:

![ring screenshot](ring_screenshot.png?raw=true)

The web shell PHP is compressed via gzip and Xor-encoded with the 9-byte key "G0YgIaXqx".
Gzipping the PHP is a pretty good way to conceal the Xor bytes,
and even makes it hard to guess the Xor byte key length,
since the Zip algorithm removes redundancy from the PHP code, 
and only has small, 3-bit "header" values interspersed throughout the compress data.
I was not clever enough to guess the Xor key.
I had to wait until an attacker tried to invoke `ring.php`.
My honey pot code caught the "_f_wp" parameter's value.

The code is about 1/3 the size of a WSO variant,
and it doesn't provide the same features.
This is a bare-bones web shell.
It does directory-tree exploration, complete with delete, rename, copy and download of files.
It can do immediate eval of pasted-in PHP code, as well as executing shell commands server-side on the compromised host.
It can do simple server recon, including a summary of server and HTTP server software versions, and `phpinfo()` output.
It does not do the "string tools" string format encoding and decoding that WSO does,
nor does it offer as extensive reconnaissance features.

Coding style is very terse.  Short function and var names. Does this extend into the JavaScript?

Has 3 PHP class declarations. class zc creates PKZip Zip archives in pure PHP.
Does this look like WSO's version?

class sc provides a database-independent interface for MySQL, Postgres and MSSql databases.
Uses `mssql_` and `mysql_` prefixed functions which were removed from PHP 7.0.

Does a couple of `define()`. IW for "is windows?", ST, PE if `posix_geteuid()` exists as function.
It will only offer to "bruteforce" passwords on non-Windows machines.
Uses cmd.exe in back connect and bind shells on Windows, /bin/sh on non-Windows

Looks for PHP versions less than 5.4

IW does effect whether it uses '/' or '\' to compose file names.

Keeps a PHP "session"

session has
	CP - working directory on compromised machine, originally dirname($_SERVER['SCRIPT_FILENAME'])
	CS - character set, UTF-8
	MO -
	CO -
	CP -
	DB -

HTML and JavaScript mixed-in with PHP.

Control of PHP actions via what HTTP parameters? Similar to WSO or not?

How is HTML coding?

    <!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"/>

### Back-connect and bind-port shells

perl, exec'ed without a fyll-y qualified path on both Windows and non-Windows.

similarity to other such Perl shells? izocin, fx29, WSO?

## Subsequent accesses
