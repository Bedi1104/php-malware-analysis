# Mumblehard Encounters

I tripped over an instance of [Mumblehard](../chat.pl).
This is my bulk encounter with the purveyors of that botnet.

I'll concentrate on analyis of how these instances differ,
rather than carefully examine any one piece of code.

## Origins

These files got downloaded from a global array of IP addresses.

|Download date      |From IP    | Address space    | Who |
|-------------------|-----------|------------------|-------------------|
|2017-11-23T09:12:53|46.4.61.180|46.4.0.0/16AS24940|Hetzner Online GmbH|
|2017-11-23T09:12:54|85.214.116.207|85.214.116.0/24AS6724|Strato AG, Berlin|
|2017-12-15T06:18:40|87.106.242.16|87.106.0.0/16AS8560|1&1 Internet SE, Karlsruhe|
|2017-12-15T06:18:42|176.9.85.238|176.9.0.0/16AS24940|Hetzner Online GmbH|
|2018-01-13T15:50:34|198.23.60.134|AS32748|LiquidNet US LLC, Coral Springs, FL|
|2018-01-13T15:50:37|104.238.72.65|AS26496|GoDaddy.com, Scottsdale, AZ|
|2018-01-23T11:09:31|31.131.251.74|31.131.251.0/24AS49505|Network of data-centers "Selectel", St Petersburg, Russia|
|2018-01-23T11:09:44|5.196.39.196|AS16276|OVH IT|
|2018-03-07T09:09:33|163.44.207.227|163.44.204.0 - 163.44.207.255|GMO-Z.com Runsystem Joint Stock Company, Ha Noi, Viet Nam|
|2018-03-07T09:09:36|50.63.9.129|AS26496|GoDaddy.com, LLC|
|2018-03-16T05:12:24|88.208.204.45|88.208.192.0/18AS8560|Fasthosts Internet Limited, Glouster, UK|
|2018-03-16T05:12:29|154.34.28.155|154.34.0.0 - 154.34.63.255|Yahoo Japan Corporation|
|2018-04-02T03:27:47|185.98.60.237|AS29262|IDEAL HOSTING SUNUCU INTERNET, Istanbul|
|2018-04-02T03:27:52|203.6.149.67|203.6.148.0 - 203.6.149.255|Universitas Sebelas Maret, Surakarta, Indonesia|
|2018-04-30T16:16:59|185.195.76.76|185.195.76.0/22AS51559|Speed Hosting Telekomunikasyon ve Yapi Hizmetleri Ltd|
|2018-04-30 16:17:02|132.148.141.38|132.148.0.0/16|GoDaddy.com, LLC|

I run [p0f3](http://lcamtuf.coredump.cx/p0f3/) on my gateway machine.
I can correlate what `p0f3` can guess about the OS sending the TCP SYN packet
with the HTTP requests.
All the above connections were made by Linux machines:

| Time Stamp            |IP Address| TCP from port |    p0f3 OS Guess       |
|-----------------------|----------------|-----------|----------------------|
|2016-04-22 13:59:48-06 | 104.238.72.65  |     50316 | Linux 3.1-3.10|
|2016-04-22 13:59:48-06 | 104.238.72.65  |     50316 | Linux 3.1-3.10|
|2016-09-21 12:28:11-06 | 104.238.72.65  |     43900 | Linux 3.1-3.10|
|2016-10-31 14:42:41-06 | 104.238.72.65  |     40904 | Linux 3.1-3.10|
|2016-11-09 23:16:32-07 | 104.238.72.65  |     36046 | Linux 3.1-3.10|
|2017-11-23 09:12:52-07 | 46.4.61.180    |     52692 | Linux 3.x|
|2017-11-23 09:12:54-07 | 85.214.116.207 |     57248 | Linux 3.1-3.10|
|2017-12-15 06:18:39-07 | 87.106.242.16  |     45897 | Linux 2.6.x|
|2017-12-15 06:18:41-07 | 176.9.85.238   |     33782 | Linux 3.1-3.10|
|2018-01-13 15:50:34-07 | 198.23.60.134  |     52144 | Linux 3.1-3.10|
|2018-01-13 15:50:37-07 | 104.238.72.65  |     41371 | Linux 3.1-3.10|
|2018-01-23 11:09:30-07 | 31.131.251.74  |     46660 | Linux 3.11 and newer|
|2018-01-23 11:09:43-07 | 5.196.39.196   |     47676 | Linux 3.1-3.10|
|2018-01-30 06:07:08-07 | 88.208.204.45  |     46444 | Linux 3.1-3.10|
|2018-01-30 06:10:59-07 | 31.131.251.74  |     34730 | Linux 3.11 and newer|
|2018-03-07 09:09:30-07 | 163.44.207.227 |     54476 | Linux 3.11 and newer|
|2018-03-07 09:09:36-07 | 50.63.9.129    |     45615 | Linux 2.6.x|
|2018-03-16 05:12:23-06 | 88.208.204.45  |     39240 | Linux 3.1-3.10|
|2018-03-16 05:12:28-06 | 154.34.28.155  |     52976 | Linux 3.1-3.10|
|2018/04/30 16:16:57 |185.195.76.76 | 58402 |Linux 3.1-3.10|
|2018/04/30 16:17:01 |132.148.141.38 | 47660 |Linux 3.1-3.10|

They do consistently run Linux.

Those IP addresses have only attempted to download Mumblehard to my honey pot,
except for 104.238.72.65, which apparently scans for unmaintained WordPress sites:

| Time Stamp            | IP Address     |Response Code   |  URI |
|-----------------------|----------------|----------------|------|
|2016-04-22 13:59:48-06 | 104.238.72.65  |302| /old/wp-admin/|
|2016-06-20 20:33:08-06 | 104.238.72.65  |404| /test/wp-admin/|
|2016-08-16 00:37:06-06 | 104.238.72.65  |404| /blog/wp-admin/|
|2016-09-21 12:28:11-06 | 104.238.72.65  |404| /wp/wp-admin/|
|2016-10-31 14:42:42-06 | 104.238.72.65  |404| /wp/wp-admin/|
|2016-11-09 23:16:32-07 | 104.238.72.65  |404| /wp-admin/|

The next time any of the attacker IP addresses show up,
they ask for a URI that's not one that 104.238.72.65 checked for.
That's no mystery,
I gather that URLs for web shells and backdoors are sold or traded  somewhere on line.

### Download

These all got downloaded via a fake WSO web shell that's part of my WordPress honey pot.
I'm not sure that the attacker intended to use a WSO web shell,
or some other backdoor or web shell.

Some attemtps sent 'ev', 'sc' and 'pass><input' as names of POST HTTP parameters.
The use of an 'ev' parameter matches [another backdoor I've caught](../176.234.34.233-2018-04-13a),
but that backdoor does not need a 'sc' or 'pass><input' parameter to work.

Other attempts sent 'pass', 'a', 'ajax' and 'p1' as names of POST HTTP parameters.
These are names of parameters used by the well known WSO or "FilesMan" web shell.
For these download attempts, the attacker tried to invoke WSO's "Php" action.

All download attemtps used:

    /wordpress/wp-content/plugins/revslider/temp/update_extract/revslider/db.php

as the request URI.
This seems strange,
as the initial, PHP dropper uses two sets of HTTP parameters.

## Deobfuscating

I did deobfuscating with scripts, because I had too many files to do
each individually.

1. Run script `getit` to copy files to `files/`
2. Run script `editem` to trim out the base64-encoded Perl. That ended up in `base64/`
Also had to do hand-editing on a few files, because `editem` isn't slick enough.
3. Fix up the base64-encoded texts by running script `create_dropper`.
This creates "droppers" in `phpdroppers/`
4. Run the PHP droppers using script `create_pl`. Perl files in `pl/`
5. Trim uuencoded payloads out of Perl scripts in `pl` by running script `create_persistent`.
Uuencoded payloads in directory `uuencoded/`.
The payloads also get the uuencode "begin" header and "end" trailer.
6. Uudecode the uuencoded payloads.
Run script `create_pl2`,
leaving final files in `pl2/`.

## Analysis

### Daemon

The PHP dropper code contains a Base64-encoded piece of Perl.
The dropper code decodes it, writes it to a file, and does its
level best to start the Perl in its own process.

Apparently 5 different daemons got downloaded.
I grouped these arbitrarily.

1. 198.23.60.134, 31.131.251.74, 5.196.39.196
2. 176.9.85.238, 87.106.242.16
3. 104.238.72.65
4. 154.34.28.155, 163.44.207.227, 185.98.60.237, 203.6.149.67, 50.63.9.129, 88.208.204.45
5. 46.4.61.180, 85.214.116.207
6. 132.148.141.38, 185.195.76.76

Group 5 daemons drop a FreeBSD ELF file as a persistent payload.
The other groups drop Perl persistent payloads.

Group 3 has a typo: `use IO::Selevt;` It probably wouldn't run,
but otherwise it's the same as the group 1 daemon.

Group 1 and 4 differ in the uuencoded blocks of Perl they carry.
This is due solely to choice of dead drop IP addresses used by the persistent payloads.

Group 1 and 2 differ in a lot of little particulars.
Of interest, the Group 1 daemon sets an element of a hash named "version" to 11,
while the Group 2 daemon sets version to 8.
Looks like I chose group numbers poorly.

Group 6 arrived after I did this analysis the first time.
The two daemons are identical.
Group 6 is similar to Group 4,
but differs in choice of SMTP server IP address to test,
and port number of something w/ daemon,
argument to main:

    < &main('77.72.83.83',25,'/');
    < &main('77.72.83.84',25,'/');
    > &main('77.72.83.83',94,'/');
    > &main('77.72.83.84',98,'/');

### Persistent Payloads

The daemon contains uuencoded (!!!) payloads.
Two of the downloads I caught have an ELF-format-file, [this](pl2/46_4_61_180) and [this](pl2/85_214_116_207).
The `file` command say: "ELF 32-bit LSB executable, Intel 80386, version 1 (FreeBSD), statically linked, not stripped".
FreeBSD.
A quick `strings` command indicates this is true. Incidentally, these are the two oldest downloads.
At a guess, since these ELF files have a function named `xordat`, there's some other code
hidden inside, exclusive-or-encoded. If I was thorough, I'd get that dumped and decoded.

Based on the Eset [yara rule](https://github.com/eset/malware-ioc/blob/master/mumblehard/mumblehard_packer.yar)
these 2 ELF files are both "mumblehard packer".

#### Dead drop IP addresses

The Perl persistent payload (run every 10 minutes by `cron`) chooses 
to retrieve a file
from a list of IP addresses.
These IP addresses change from download to download.
In fact, this is the only difference between persistent payloads.

|Download date      |Group|From IP    |Dead drop IPs     | HTTP parameters|
|-------------------|-----|-----------|------------------|----------------|
|2017-11-23T09:12:53|5|46.4.61.180|N/A - ELF|pass,a, ajax, p1|
|2017-11-23T09:12:54|5|85.214.116.207|N/A - ELF|pass><input, ev|
|2017-12-15T06:18:40|2|87.106.242.16|5.135.42.98, 198.245.49.106|pass, a, ajax, p1|
|2017-12-15T06:18:42|2|176.9.85.238|5.135.42.98, 77.72.83.83|pass><input, ev|
|2018-01-13T15:50:34|1|198.23.60.134|5.135.42.98, 77.72.83.83|pass, a, ajax, p1|
|2018-01-13T15:50:37|3|104.238.72.65|5.135.42.98, 77.72.83.83|pass><input, ev|
|2018-01-23T11:09:31|1|31.131.251.74|5.135.42.98, 77.72.83.83|pass, a, ajax, p1|
|2018-01-23T11:09:44|1|5.196.39.196|5.135.42.98, 77.72.83.83|pass><input, ev|
|2018-03-07T09:09:33|4|163.44.207.227|5.135.42.98, 198.245.49.106|pass, a, ajax, p1|
|2018-03-07T09:09:36|4|50.63.9.129|5.135.42.98, 198.245.49.106|pass><input, ev|
|2018-03-16T05:12:24|4|88.208.204.45|5.135.42.98, 198.245.49.106|pass, a, ajax, p1|
|2018-03-16T05:12:29|4|154.34.28.155|5.135.42.98, 198.245.49.106|pass><input, ev|
|2018-04-02T03:27:47|4|185.98.60.237|5.135.42.98, 198.245.49.106|pass, a, ajax, p1|
|2018-04-02T03:27:52|4|203.6.149.67|5.135.42.98, 198.245.49.106|pass><input, ev|
|2018-04-30T16:16:59|6|185.195.76.76|5.135.42.98, 198.245.49.106|pass, a, ajax, p1|
|2018-04-30T16:17:02|6|132.148.141.38|5.135.42.98, 198.245.49.106|pass><input, ev|

5.135.42.98 is an OVH dedicated server in France, according to `geoiplookup`.
198.245.49.106 is an OVH Hosting IP in Canada.
77.72.83.83 is from Quasinetworks in UK.

If you look closely at the timestamps,
it appears that two IP address download PHP droppers within a few seconds
of each other.
The pairs of requests use different sets of HTTP parameters.
It seems that there's two web shells being targeted in parallel,
by different attacking servers.
Request from the server targetting non-WSO web shells always arrive
a few seconds after the server targetting WSO webs shells.
It may be a secondary, or slave server, or maybe the operator
just habitually starts it second.

Amusing. They start with the ELF file persistent payloads,
move to the Perl "version 8", make a typo in a version 8 file,
then move to version 11. Looks like I may be missing versions 9 and 10.
The two downloads from 2018-04-30 (Group 6) have version 112.
