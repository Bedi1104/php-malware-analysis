function main()
{
$test=array("os"=>array(PHP_OS),"ip"=>array("0.0.0.0","checkip.dyndns.org","checkip.org"),"tcp25"=>array(0,"mailin-01.mx.aol.com","mta5.am0.yahoodns.net","mx1.hotmail.com"),"udp53"=>array(0,"dns-01.ns.aol.com","ns1.yahoo.com","ns1.msft.net"),"tcp53"=>array(0,"dns-01.ns.aol.com","ns1.yahoo.com","ns1.msft.net"),"tcp80"=>array(0,"aol.com","yahoo.com"));
$readers=array();$writers=array();$session=array();
foreach($test as $result=>$values)
{
while(1<count($values))
{
$host=array_pop($values);$addr=gethostbyname($host);if($addr==$host) continue;$protocol;$port;
if($result=="ip")
{
$protocol="tcp";$port=80;
}
else
{
preg_match("/^(tcp|udp)(\d+)$/",$result,$match);
$protocol=$match[1];$port=$match[2];
}
$socket;
if($protocol=="tcp")
{
if(!($socket=@socket_create(AF_INET,SOCK_STREAM,SOL_TCP))) continue;
}
else
{
if(!($socket=@socket_create(AF_INET,SOCK_DGRAM,SOL_UDP))) continue;
}
socket_set_nonblock($socket);$status="wr";
if($protocol=="tcp")
{
if(!@socket_connect($socket,$addr,$port))
{
$error=socket_last_error($socket);socket_clear_error($socket);
if($error!=SOCKET_EINPROGRESS && $error!=SOCKET_EISCONN && $error!=SOCKET_EWOULDBLOCK && $error!=SOCKET_EALREADY)
{
socket_close($socket);continue;
}
}
$status="cn";
}
select_add($writers,$socket);$session["$socket"]=array("status"=>$status,"buffer"=>"","timeout"=>5,"result"=>$result,"addr"=>$addr,"port"=>$port);
if($port==53)
{
$session["$socket"]["buffer"].=pack("nSn4",rand(1,65535),1,1,0,0,0);
foreach(explode(".",$host) as $part)
{
$session["$socket"]["buffer"].=pack("C",strlen($part)).$part;
}
$session["$socket"]["buffer"].=pack("Cn2",0,1,1);
if($protocol=="tcp") $session["$socket"]["buffer"]=pack("n",strlen($session["$socket"]["buffer"])).$session["$socket"]["buffer"];
}
elseif($port==80)
{
$session["$socket"]["buffer"]=implode("\r\n",array("GET / HTTP/1.1","Accept: image/gif, image/x-xbitmap, image/jpeg, image/pjpeg, */*","User-Agent: Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1)","Host: $host","Connection: close","Cache-Control: no-cache","\r\n"));
}
}
}
foreach(array_keys($session) as $handle)
{
$session["$handle"]["timeout"]+=time();
}
while(count($readers) || count($writers))
{
$time=time();
$writable=select_writable($writers);
foreach($writable as $handle)
{
if($session["$handle"]["status"]=="cn")
{
$error=socket_last_error($handle);socket_clear_error($handle);
if($error!=0)
{
$session["$handle"]["timeout"]=0;
}
else
{
if($session["$handle"]["result"]=="tcp25")
{
$session["$handle"]["status"]="rd";select_add($readers,$handle);select_remove($writers,$handle);
}
else
{
$session["$handle"]["status"]="wr";
}
}
}
else
{
if($session["$handle"]["result"]=="udp53")
{
$result=@socket_sendto($handle,$session["$handle"]["buffer"],strlen($session["$handle"]["buffer"]),0,$session["$handle"]["addr"],$session["$handle"]["port"]);
}
elseif($session["$handle"]["result"]=="tcp53")
{
$result=@socket_send($handle,$session["$handle"]["buffer"],strlen($session["$handle"]["buffer"]),0);
}
else
{
$result=@socket_write($handle,$session["$handle"]["buffer"]);
}
if($result===FALSE && (socket_last_error($handle)==SOCKET_EWOULDBLOCK))
{
socket_clear_error($handle);
}
elseif($result>0)
{
$session["$handle"]["buffer"]=substr($session["$handle"]["buffer"],$result);
if(strlen($session["$handle"]["buffer"])<1)
{
$session["$handle"]["status"]="rd";select_add($readers,$handle);select_remove($writers,$handle);
}
}
else
{
$session["$handle"]["timeout"]=0;
}
}
}
$readable=select_readable($readers);
foreach($readable as $handle)
{
if($session["$handle"]["result"]=="udp53")
{
$result=@socket_recvfrom($handle,$session["$handle"]["buffer"],512,0,$session["$handle"]["addr"],$session["$handle"]["port"]);
}
elseif($session["$handle"]["result"]=="tcp53")
{
$result=@socket_recv($handle,$session["$handle"]["buffer"],2,0);
}
else
{
$result=@socket_read($handle,8192);
if($result!==FALSE)
{
$session["$handle"]["buffer"].=$result;$result=strlen($result);
}
}
if($result===FALSE && (socket_last_error($handle)==SOCKET_EWOULDBLOCK))
{
socket_clear_error($handle);
}
elseif($result>=0)
{
if($session["$handle"]["result"]=="ip")
{
if($test[$session["$handle"]["result"]][0]=="0.0.0.0")
{
if(preg_match("/(\d+\.\d+\.\d+\.\d+)/",$session["$handle"]["buffer"],$match))
{
$test[$session["$handle"]["result"]][0]=$match[1];$session["$handle"]["timeout"]=0;
}
}
else
{
$session["$handle"]["timeout"]=0;
}
}
elseif($result>0)
{
$test[$session["$handle"]["result"]][0]=1;$session["$handle"]["timeout"]=0;
}
}
else
{
$session["$handle"]["timeout"]=0;
}
}
foreach($writers as $handle)
{
if($time>=$session["$handle"]["timeout"])
{
select_remove($writers,$handle);unset($session["$handle"]);socket_close($handle);
}
}
foreach($readers as $handle)
{
if($time>=$session["$handle"]["timeout"])
{
select_remove($readers,$handle);unset($session["$handle"]);socket_close($handle);
}
}
}
if($test["tcp25"][0]==1) echo "z5a7" . "ht8d=tcp25open=";
if($test["tcp25"][0]==0) echo "z5a7" . "ht8d=tcp25close=";
}
function select_add(&$o,$h)
{
if(1024>count($o))
{
array_push($o,$h);return TRUE;
}
return FALSE;
}
function select_remove(&$o,$h)
{
$i=count($o);if($i<1) return;
while($i--)
{
$s=array_shift($o);if($s!=$h) array_push($o,$s);
}
}
function select_readable(&$o)
{
$r=$o;if(count($r)) socket_select($r,$w=NULL,$e=NULL,0);return $r;
}
function select_writable(&$o)
{
$w=$o;if(count($w)) socket_select($r=NULL,$w,$e=NULL,0);return $w;
}
error_reporting(0);set_time_limit(0);main();
