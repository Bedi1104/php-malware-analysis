# File downloader and updater

PHP malware that can keep a set of PHP and HTML files
filled with designated contents.

## Origin

## IP Adress 178.128.188.142

No previous accesses by 178.128.188.142

No DNS name for 178.128.188.142

It's a Digital Ocean IP address, kind of a dry well

[p0f3](http://lcamtuf.coredump.cx/p0f3/) seems to think that a "Windows NT kernel" was driving 178.128.188.142.

<!--
[2019/06/25 18:25:10] mod=syn|cli=178.128.188.142/50958|srv=162.246.45.144/80|subj=cli|os=Windows NT kernel|dist=8|params=generic|raw_sig=4:120+8:0:1360:mss*48,8:mss,nop,ws,nop,nop,sok:df,id+:0
[2019/06/25 18:25:10] mod=mtu|cli=178.128.188.142/50958|srv=162.246.45.144/80|subj=cli|link=generic tunnel or VPN|raw_mtu=1400
[2019/06/25 18:25:10] mod=syn+ack|cli=178.128.188.142/50958|srv=162.246.45.144/80|subj=srv|os=???|dist=0|params=none|raw_sig=4:64+0:0:1460:mss*44,7:mss,nop,nop,sok,nop,ws:df:0
[2019/06/25 18:25:10] mod=mtu|cli=178.128.188.142/50958|srv=162.246.45.144/80|subj=srv|link=Ethernet or modem|raw_mtu=1500
[2019/06/25 18:25:10] mod=syn|cli=178.128.188.142/50959|srv=162.246.45.144/80|subj=cli|os=Windows NT kernel|dist=8|params=generic|raw_sig=4:120+8:0:1360:mss*48,8:mss,nop,ws,nop,nop,sok:df,id+:0
[2019/06/25 18:25:10] mod=mtu|cli=178.128.188.142/50959|srv=162.246.45.144/80|subj=cli|link=generic tunnel or VPN|raw_mtu=1400
[2019/06/25 18:25:10] mod=syn+ack|cli=178.128.188.142/50959|srv=162.246.45.144/80|subj=srv|os=???|dist=0|params=none|raw_sig=4:64+0:0:1460:mss*44,7:mss,nop,nop,sok,nop,ws:df:0
[2019/06/25 18:25:10] mod=mtu|cli=178.128.188.142/50959|srv=162.246.45.144/80|subj=srv|link=Ethernet or modem|raw_mtu=1500
[2019/06/25 18:25:14] mod=http request|cli=178.128.188.142/50959|srv=162.246.45.144/80|subj=cli|app=Chrome 51.x or newer|lang=English|params=none|raw_sig=1:Host,Connection=[keep-alive],Upgrade-Insecure-Requests=[1],User-Agent,Accept=[text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8],Accept-Encoding=[gzip, deflate, sdch],Accept-Language=[en-US,en;q=0.8]:Accept-Charset,Keep-Alive:Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36
[2019/06/25 18:25:14] mod=http response|cli=178.128.188.142/50959|srv=162.246.45.144/80|subj=srv|app=Apache 2.x|lang=none|params=none|raw_sig=1:Date,Server,X-Powered-By=[PHP/7.3.6],?Content-Length,Keep-Alive=[timeout=5, max=100],Connection=[Keep-Alive],Content-Type:Accept-Ranges:Apache/2.4.39 (Unix) PHP/7.3.6
[2019/06/25 18:27:03] mod=syn|cli=178.128.188.142/51165|srv=162.246.45.144/80|subj=cli|os=Windows NT kernel|dist=8|params=generic|raw_sig=4:120+8:0:1360:mss*48,8:mss,nop,ws,nop,nop,sok:df,id+:0
[2019/06/25 18:27:03] mod=mtu|cli=178.128.188.142/51165|srv=162.246.45.144/80|subj=cli|link=generic tunnel or VPN|raw_mtu=1400
[2019/06/25 18:27:03] mod=syn+ack|cli=178.128.188.142/51165|srv=162.246.45.144/80|subj=srv|os=???|dist=0|params=none|raw_sig=4:64+0:0:1460:mss*44,7:mss,nop,nop,sok,nop,ws:df:0
[2019/06/25 18:27:03] mod=mtu|cli=178.128.188.142/51165|srv=162.246.45.144/80|subj=srv|link=Ethernet or modem|raw_mtu=1500
[2019/06/25 18:43:50] mod=syn|cli=178.128.188.142/51908|srv=162.246.45.144/80|subj=cli|os=Windows NT kernel|dist=8|params=generic|raw_sig=4:120+8:0:1360:mss*48,8:mss,nop,ws,nop,nop,sok:df,id+:0
[2019/06/25 18:43:50] mod=mtu|cli=178.128.188.142/51908|srv=162.246.45.144/80|subj=cli|link=generic tunnel or VPN|raw_mtu=1400
[2019/06/25 18:43:50] mod=syn+ack|cli=178.128.188.142/51908|srv=162.246.45.144/80|subj=srv|os=???|dist=0|params=none|raw_sig=4:64+0:0:1460:mss*44,7:mss,nop,nop,sok,nop,ws:df:0
[2019/06/25 18:43:50] mod=mtu|cli=178.128.188.142/51908|srv=162.246.45.144/80|subj=srv|link=Ethernet or modem|raw_mtu=1500
[2019/06/25 18:43:56] mod=syn|cli=178.128.188.142/51912|srv=162.246.45.144/80|subj=cli|os=Windows NT kernel|dist=8|params=generic|raw_sig=4:120+8:0:1360:mss*48,8:mss,nop,ws,nop,nop,sok:df,id+:0
[2019/06/25 18:43:56] mod=mtu|cli=178.128.188.142/51912|srv=162.246.45.144/80|subj=cli|link=generic tunnel or VPN|raw_mtu=1400
[2019/06/25 18:43:56] mod=syn+ack|cli=178.128.188.142/51912|srv=162.246.45.144/80|subj=srv|os=???|dist=0|params=none|raw_sig=4:64+0:0:1460:mss*44,7:mss,nop,nop,sok,nop,ws:df:0
[2019/06/25 18:43:56] mod=mtu|cli=178.128.188.142/51912|srv=162.246.45.144/80|subj=srv|link=Ethernet or modem|raw_mtu=1500
[2019/06/25 18:44:04] mod=syn|cli=178.128.188.142/51915|srv=162.246.45.144/80|subj=cli|os=Windows NT kernel|dist=8|params=generic|raw_sig=4:120+8:0:1360:mss*48,8:mss,nop,ws,nop,nop,sok:df,id+:0
[2019/06/25 18:44:04] mod=mtu|cli=178.128.188.142/51915|srv=162.246.45.144/80|subj=cli|link=generic tunnel or VPN|raw_mtu=1400
[2019/06/25 18:44:04] mod=syn+ack|cli=178.128.188.142/51915|srv=162.246.45.144/80|subj=srv|os=???|dist=0|params=none|raw_sig=4:64+0:0:1460:mss*44,7:mss,nop,nop,sok,nop,ws:df:0
[2019/06/25 18:44:04] mod=mtu|cli=178.128.188.142/51915|srv=162.246.45.144/80|subj=srv|link=Ethernet or modem|raw_mtu=1500
[2019/06/25 18:57:37] mod=syn|cli=178.128.188.142/52467|srv=162.246.45.144/80|subj=cli|os=Windows NT kernel|dist=8|params=generic|raw_sig=4:120+8:0:1360:mss*48,8:mss,nop,ws,nop,nop,sok:df,id+:0
[2019/06/25 18:57:37] mod=mtu|cli=178.128.188.142/52467|srv=162.246.45.144/80|subj=cli|link=generic tunnel or VPN|raw_mtu=1400
[2019/06/25 18:57:37] mod=syn+ack|cli=178.128.188.142/52467|srv=162.246.45.144/80|subj=srv|os=???|dist=0|params=none|raw_sig=4:64+0:0:1460:mss*44,7:mss,nop,nop,sok,nop,ws:df:0
[2019/06/25 18:57:37] mod=mtu|cli=178.128.188.142/52467|srv=162.246.45.144/80|subj=srv|link=Ethernet or modem|raw_mtu=1500
[2019/06/25 18:57:37] mod=syn|cli=178.128.188.142/52468|srv=162.246.45.144/80|subj=cli|os=Windows NT kernel|dist=8|params=generic|raw_sig=4:120+8:0:1360:mss*48,8:mss,nop,ws,nop,nop,sok:df,id+:0
[2019/06/25 18:57:37] mod=mtu|cli=178.128.188.142/52468|srv=162.246.45.144/80|subj=cli|link=generic tunnel or VPN|raw_mtu=1400
[2019/06/25 18:57:37] mod=syn+ack|cli=178.128.188.142/52468|srv=162.246.45.144/80|subj=srv|os=???|dist=0|params=none|raw_sig=4:64+0:0:1460:mss*44,7:mss,nop,nop,sok,nop,ws:df:0
[2019/06/25 18:57:37] mod=mtu|cli=178.128.188.142/52468|srv=162.246.45.144/80|subj=srv|link=Ethernet or modem|raw_mtu=1500
[2019/06/25 18:57:37] mod=syn|cli=178.128.188.142/52469|srv=162.246.45.144/80|subj=cli|os=Windows NT kernel|dist=8|params=generic|raw_sig=4:120+8:0:1360:mss*48,8:mss,nop,ws,nop,nop,sok:df,id+:0
[2019/06/25 18:57:37] mod=mtu|cli=178.128.188.142/52469|srv=162.246.45.144/80|subj=cli|link=generic tunnel or VPN|raw_mtu=1400
[2019/06/25 18:57:37] mod=syn+ack|cli=178.128.188.142/52469|srv=162.246.45.144/80|subj=srv|os=???|dist=0|params=none|raw_sig=4:64+0:0:1460:mss*44,7:mss,nop,nop,sok,nop,ws:df:0
[2019/06/25 18:57:37] mod=mtu|cli=178.128.188.142/52469|srv=162.246.45.144/80|subj=srv|link=Ethernet or modem|raw_mtu=1500
[2019/06/25 18:57:37] mod=syn|cli=178.128.188.142/52470|srv=162.246.45.144/80|subj=cli|os=Windows NT kernel|dist=8|params=generic|raw_sig=4:120+8:0:1360:mss*48,8:mss,nop,ws,nop,nop,sok:df,id+:0
[2019/06/25 18:57:37] mod=mtu|cli=178.128.188.142/52470|srv=162.246.45.144/80|subj=cli|link=generic tunnel or VPN|raw_mtu=1400
[2019/06/25 18:57:37] mod=syn+ack|cli=178.128.188.142/52470|srv=162.246.45.144/80|subj=srv|os=???|dist=0|params=none|raw_sig=4:64+0:0:1460:mss*44,7:mss,nop,nop,sok,nop,ws:df:0
[2019/06/25 18:57:37] mod=mtu|cli=178.128.188.142/52470|srv=162.246.45.144/80|subj=srv|link=Ethernet or modem|raw_mtu=1500
[2019/06/25 18:57:40] mod=http request|cli=178.128.188.142/52469|srv=162.246.45.144/80|subj=cli|app=Chrome 51.x or newer|lang=English|params=none|raw_sig=1:Host,Connection=[keep-alive],Upgrade-Insecure-Requests=[1],User-Agent,Accept=[text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8],Accept-Encoding=[gzip, deflate, sdch],Accept-Language=[en-US,en;q=0.8]:Accept-Charset,Keep-Alive:Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36
[2019/06/25 18:57:40] mod=http response|cli=178.128.188.142/52469|srv=162.246.45.144/80|subj=srv|app=Apache 2.x|lang=none|params=none|raw_sig=1:Date,Server,X-Powered-By=[PHP/7.3.6],?Content-Length,Keep-Alive=[timeout=5, max=100],Connection=[Keep-Alive],Content-Type:Accept-Ranges:Apache/2.4.39 (Unix) PHP/7.3.6
[2019/06/25 19:00:19] mod=syn|cli=178.128.188.142/52710|srv=162.246.45.144/80|subj=cli|os=Windows NT kernel|dist=8|params=generic|raw_sig=4:120+8:0:1360:mss*48,8:mss,nop,ws,nop,nop,sok:df,id+:0
[2019/06/25 19:00:19] mod=mtu|cli=178.128.188.142/52710|srv=162.246.45.144/80|subj=cli|link=generic tunnel or VPN|raw_mtu=1400
[2019/06/25 19:00:19] mod=syn+ack|cli=178.128.188.142/52710|srv=162.246.45.144/80|subj=srv|os=???|dist=0|params=none|raw_sig=4:64+0:0:1460:mss*44,7:mss,nop,nop,sok,nop,ws:df:0
[2019/06/25 19:00:19] mod=mtu|cli=178.128.188.142/52710|srv=162.246.45.144/80|subj=srv|link=Ethernet or modem|raw_mtu=1500
-->

<!--
178.128.188.142 - - [25/Jun/2019:18:25:14 -0600] "GET /wp-content/plugins/revslider/temp/update_extract/revslider/db.php HTTP/1.1" 200 120 "-" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"
178.128.188.142 - - [25/Jun/2019:18:25:14 -0600] "GET /favicon.ico HTTP/1.1" 200 319 "http://www.stratigery.com/wp-content/plugins/revslider/temp/update_extract/revslider/db.php" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"
178.128.188.142 - - [25/Jun/2019:18:27:04 -0600] "POST /wp-content/plugins/revslider/temp/update_extract/revslider/db.php HTTP/1.1" 200 13918 "http://www.stratigery.com/wp-content/plugins/revslider/temp/update_extract/revslider/db.php" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"
178.128.188.142 - - [25/Jun/2019:18:43:50 -0600] "POST /wp-content/plugins/revslider/temp/update_extract/revslider/db.php HTTP/1.1" 200 21849 "http://www.stratigery.com/wp-content/plugins/revslider/temp/update_extract/revslider/db.php" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"
178.128.188.142 - - [25/Jun/2019:18:43:56 -0600] "POST /wp-content/plugins/revslider/temp/update_extract/revslider/db.php HTTP/1.1" 200 21849 "http://www.stratigery.com/wp-content/plugins/revslider/temp/update_extract/revslider/db.php" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"
178.128.188.142 - - [25/Jun/2019:18:44:05 -0600] "POST /wp-content/plugins/revslider/temp/update_extract/revslider/db.php HTTP/1.1" 200 21849 "http://www.stratigery.com/wp-content/plugins/revslider/temp/update_extract/revslider/db.php" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"
178.128.188.142 - - [25/Jun/2019:18:57:40 -0600] "GET /wp-content/plugins/revslider/temp/update_extract/revslider/db.php HTTP/1.1" 200 120 "-" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"
178.128.188.142 - - [25/Jun/2019:19:00:20 -0600] "POST /wp-content/plugins/revslider/temp/update_extract/revslider/db.php HTTP/1.1" 200 13982 "http://www.stratigery.com/wp-content/plugins/revslider/temp/update_extract/revslider/db.php" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"
178.128.188.142 - - [25/Jun/2019:19:00:22 -0600] "POST /wp-content/plugins/revslider/temp/update_extract/revslider/db.php HTTP/1.1" 200 21849 "http://www.stratigery.com/wp-content/plugins/revslider/temp/update_extract/revslider/db.php" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"
178.128.188.142 - - [25/Jun/2019:19:00:26 -0600] "POST /wp-content/plugins/revslider/temp/update_extract/revslider/db.php HTTP/1.1" 200 21849 "http://www.stratigery.com/wp-content/plugins/revslider/temp/update_extract/revslider/db.php" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.36"
-->

## Accesses

All accesses made to a URL ending in `/wp-content/plugins/revslider/temp/update_extract/revslider/db.php`


|Timestamp|Remote Port |Elapsed Time|HTTP Parameters|
|---------|------------|------------:|--------------|
|2019-06-25T07:00:20.092-0600|52710||pass=nhzgrf|
|2019-06-25T07:00:22.010-0600|52710|1.918|a=FilesMan, c=/var/www/html|
|2019-06-25T07:00:26.944-0600|52710|4.934|a=FilesMAn, c=/var/www/html/,p1=uploadFile|

Direct login with HTTP parameter pass=nhzgrf
would seem to mean that this was an automated campaign,
but the interval between requests is just large enough to cast doubt on that.

"nhzgrf" is an exceedingly popular WSO web shell password.

All HTTP parameters indicate that the attacker(s) thought they
were dealing with a WSO (Web Shell by oRb) web shell.
The third request even has the value of the "a" parameters as the oddly capitalized "FilesMAn",
which is characteristic of requests made of WSO by itself,
it's the default action of WSO.

The final HTTP request sent a file that was named `getfile.php`
on the attacker(s) computer.

No further requests, not even for `getfile.php`

## Analysis

Apparently you're supposed to invoke `getfile.php` with an HTTP GET request
containing a parameter named "use", and having a value of "1", "2" or "3".

You can also access `getfile.php` with an HTTP GET request, and a parameter named "check".
`getfile.php` code tries to open each of a list of file names.
If the code finds a string `//file end` in any of the list of file names,
it prints some HTML noting that "$values has successed!" where "$values" is the file name.
Otherwise, it prints HTML that says "file $values must be reload!",
or if it can't find the file name,
it says "file $values not found!".

Accessing `getfile.php` with a GET parameter named "urls" causes another action.
The code uses the value of parameter "urls" as a URL. Shocking, I know.
The URL get retrieved via a method chosen using the value of the HTTP parameter named "use". See above.
The contents of the URL so retrieved is treated as a set of URLs,
and the suffix (Unix basename style) is treated as a file name.
The code retrieves the contents of the URL and fills in the file name
with those contents.
There's an HTML notation about which retrievals and which file fills succeed and fail,
similar to the "check" action described above.

Files used in "check" and probably "urls" actions:

    id0.php
    id1.php
    id2.php
    id3.php
    id4.php
    id5.php
    id6.php
    id7.php
    id8.php
    id9.php
    id10.php
    id11.php
    id12.php
    id13.php
    id14.php
    id15.php
    id16.php
    id17.php
    id18.php
    id19.php
    id20.php
    id21.php
    id22.php
    id23.php
    id24.php
    id25.php
    id26.php
    id27.php
    id28.php
    id29.php
    id30.php
    id31.php
    id32.php
    id33.php
    id34.php
    id35.php
    id36.php
    id37.php
    id38.php
    id39.php
    id40.php
    id41.php
    id42.php
    id43.php
    id44.php
    id45.php
    id46.php
    id47.php
    id48.php
    id49.php
    index.php
    DeleteID.txt
    moban.html

Looks like "Moban" is an anti-schizophrenia drug.
Pastebin has a file [moban.html](https://pastebin.com/CjncF9fm) dated 2018-04-07
that appears to be a template for a Chinese or Japanese language web page.

There's a [malware capture](https://github.com/abshkd/malware/tree/master/shells/wp-darkshell)
on github, dating from 2017, that contains much the same "moban.html" template,
and a file `installer.php` that bears a lot of similarity to `getfile.php`.
It's entirely possible that this is an evolution of the "wp-darkshell" malware.
