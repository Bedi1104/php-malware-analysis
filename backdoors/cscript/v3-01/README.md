# Extensible backdoor 3.0-1 
## Origin

### IP Address 52.64.146.190

It's an Amazon AWS IP address.
This is the sole and only time that 52.64.146.190 has accessed my web site.
This access arrived with a cookie named
"59c3080850e28cdb724eafd61e539b81", value "866fd58d77526c1bda8771b5b21d5b11".
That's a typical cookie for WSO web shells.
The name of the cookie is the MD5 hash of "www.stratigery.com",
the hostname in the URL used to access my web site.
The value of the cookie is the MD5 hash of "nhzgrf", a common password for WSO web shell instances.
A single access with a pre-set WSO password cookie would seem to indicate programmatic access.

### Download

The attacker(s) invoked a URL ending in `/wordpress/wp-content/plugins/wp-mobile-detector/cache/db.php`.
This URL has been invoked 274 times since 2017-12-08,
never before from 52.64.146.190.

The attacker(s) apparently thought they were invoking a WSO (Web Shell by oRb) web shell.
They set stereotypical WSO HTTP parameters named "a" and "p1".
Parameter named "a" had a value of "RC",
a well-known WSO function that eval's PHP source code that is the value of parameter "p1".
Conveniently, HTTP parameter "p1" arrived full of PHP source.

The attackers set two HTTP cookies along with the download.

| Cookie Name                    | Cookie value                   |
|--------------------------------|--------------------------------|
|59c3080850e28cdb724eafd61e539b81|866fd58d77526c1bda8771b5b21d5b11|
|7a017e28704d15b0d8efe38606806610|7a017e28704d15b0d8efe38606806610|

The cookie name "59c3080850e28cdb724eafd61e539b81" is the MD5 hash of the string "www.stratigery.com",
the host name the attackers used to in URLs to access my WordPress honey pot.
The value of that cookie, "866fd58d77526c1bda8771b5b21d5b11",
is the MD5 hash of "nhzgrf", an extremely common password for WSO web shells.

The second cookie,
name and value of "7a017e28704d15b0d8efe38606806610",
has much more interest.
The string "7a017e28704d15b0d8efe38606806610" is the value of this PHP calculation:

    md5(md5('www.stratigery.com') . 'www.stratigery.com' . "salt1I*@#31RTds34+543sf");

This is the kind of cookie that the [Vigilante Malware Cleaner](/vigilante_suspected) injected code
uses as a second password on WSO instances it finds.
It seems likely that the attacker(s) are the Vigilance Committe behind the Malware Cleaner,
or obtained the password and URL from the Vigilance Committee.

## Deobfuscation

1. Hand-edit `52.64.146.190XNSIpgOCAecLqsKUhEDM9gAAAAE.vigilante.scans` into `a1.php`, change "eval" to "print"
2. `php a1.php > a2.php`
3. Hand-eit `a2.php`, change "eval" to "print".
4. `php a2.php > a3.php`

`a3.php` is pretty much the backdoor source code.
It's also had all user functions and variables renamed to 
6 to 14 character long
strings of randomly-selected lowercase ASCII letters.
This makes it hard to understand.

I've done a hand-reverse-engineered [version](x3.php) with
names of variables and functions taken from [v1-02](/backdoors/cscript/extendable.php),
which arrived without the randomly-selected-variable names,
and from the internal, plain-text TdsClient code.
I had to choose a few variable and function names,
as not everything appears in the TdsClient code, or v1-02 code.

## Analysis

Three pieces of code are of interest: the dropper, the backdoor,
and an initial set of plugins kept encoded,
internally to the backdoor.

### Dropper

The [code](a1.php) sent to a WSO shell for immediate eval looks like an instance of the [Object Oriented Dropper](/backdoors/oodropper).
The object-oriented dropper did install a v2-01 instance of this same backdoor.
Another interesting coincidence, or does the Vigilance Committee like this dropper?

### The Backdoor

By looking at the hand-reverse-engineered [version](x3.php)

#### Differences from v2-01

The object oriented dropper left behind v2-01 backdoor code with variable and function names
of 6 to 14 randomly-selected characters, same as for v3-01.
I had previously written a [PHP cleaner](/clean-php) that parsed PHP source code,
then pretty-printed it while replacing all variable names with the string `variable`,
function names with the string `function`, class names with `classname`, etc etc.
The resulting code does not retain the semantics of the original.
It probably does not execute correctly,
but it does retain the "shape" of the original, obfuscated, PHP code.

Only one block of code makes the v3-01 backdoor different from v2-01 backdoors.
This block of code contains a Base64-encoded, serialized block of PHP.
After Base64-decoding, and removing the serializing information,
I found that the [block of PHP](config.php) contained another layer of obfuscation,
similar to the obfuscation used in the [backdoor itself](a2.php).
I undid that layer of obfuscation by changed "eval" to "print" and running it,
yielding code similar in structure to the extendable backdoor itself,
except object oriented.

The v3-01 backdoor Base64-decodes, and deserializes this block of code every time it executes,
putting the deserialized executable pieces in its array of plugins.
This seems a trifle odd.
It carries around code to store and retrieve plugins from its own file,
but it also carries an entire PHP class around in Base64-encoded form.
Operators can't replace or delete this code as they can the disk-stored plugins can.
They lost some functionality when they added this code.

### Deserialized Code/built-in plugins

We get to see more of the attacker's software engineering practices in
the deserialized code.
The backdoor's authors (or integrators) did not obscure the deserialized code
any more than PHP is obscure in the first place.
We get to see their function and variable naming conventions,
and code formatting practices.
All of these factors got obscured in the [backdoor itself](a3.php),
via code reformatting for obfuscation, and renaming variables and functions for obfuscation.


#### 77.87.193.14

77.87.193.14 has a DNS name of ef485.mirohost.net

ef485.mirohost.net nas an A record of 77.87.193.14

    role:           Mirohost Network Coordination Center
    address:        50 Gaydara str., Kyiv, Ukraine, 01033
    created:        2011-10-05T13:23:46Z
    last-modified:  2018-02-15T19:14:00Z
    route:          77.87.193.0/24
    descr:          Internet Invest Ltd.
    descr:          Web hosting, datacenter and domain names registration in Ukraine
    descr:          Hosting part
    descr:          Kiev, Ukraine
    org:            ORG-IIL11-RIPE
    origin:         AS28907
    created:        2013-12-08T22:56:02Z
    last-modified:  2013-12-08T22:56:02Z
