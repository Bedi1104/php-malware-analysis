# Extensible backdoor 3.0-1

## Origin

### IP Address 52.64.146.190

It's an Amazon AWS IP address.
This is the sole and only time that 52.64.146.190 has accessed my web site.
This access arrived with a cookie named
"59c3080850e28cdb724eafd61e539b81", value "866fd58d77526c1bda8771b5b21d5b11".
That's a typical cookie for WSO web shells.
The name of the cookie is the MD5 hash of "www.stratigery.com",
the hostname in the URL used to access my web site.
The value of the cookie is the MD5 hash of "nhzgrf", a common password for WSO web shell instances.
A single access with a pre-set WSO password cookie would seem to indicate programmatic access.

### Download

The attacker(s) invoked a URL ending in `/wordpress/wp-content/plugins/wp-mobile-detector/cache/db.php`.
THis URL has been invoked 274 times since 2017-12-08,

The attacker(s) apparently thought they were invoking a WSO (Web Shell by oRb) web shell.
They set stereotypical WSO HTTP parameters named "a" and "p1".
Parameter named "a" had a value of "RC",
a well-known WSO function that eval's PHP source code that is the value of parameter "p1".
Conveniently, HTTP parameter "p1" arrived full of PHP source.

There's also an extra cookie, name and value of "7a017e28704d15b0d8efe38606806610".
This is an MD5-variant hash of the host name used in the URL, "www.stratigery.com".
This is the kind of cookie that the [Vigilante Malware Cleaner](/vigilante_suspected) injected code
uses as a second password on WSO instances it finds.
It seems likely that the attacker(s) are the Vigilance Committe behind the Malware Cleaner,
or obtained the password and URL from the Vigilance Committee.

## Deobfuscation

1. Hand-edit `52.64.146.190XNSIpgOCAecLqsKUhEDM9gAAAAE.vigilante.scans` into `a1.php`, change "eval" to "print"
2. `php a1.php > a2.php`
3. Hand-eit `a2.php`, change "eval" to "print".
4. `php a2.php > a3.php`

`a3.php` is pretty much the backdoor source code.
It's also had all user functions and variables renamed to 
6 to 14 character long
strings of randomly-selected lowercase ASCII letters.
This makes it hard to understand.

I've done a hand-reverse-engineered [version](x3.php) with
names of variables and functions taken from [v1-02](),
which arrived without the randomly-selected-variable names,
and from the internal, plain-text TdsClient code.
I had to choose a few variable and function names,
as not everything appears in the TdsClient code, or v1-02 code.

## Analysis

There's 3 pieces of code that are of interest: the dropper, the backdoor,
and an initial set of plugins kept encoded,
internally to the backdoor.

### Dropper

The [code](a1.php) sent to a WSO shell for immediate eval looks like an instance of the [Object Oriented Dropper](/backdoors/oodropper).
The object-oriented dropper did install a v2-01 instance of this same backdoor.
Another interesting coincidence, or does the Vigilance Committee like this dropper?

### The Backdoor

By looking at the hand-reverse-engineered [version](x3.php)

#### Differences from v2-01

The object oriented dropper left behind v2-01 backdoor code with variable and function names
of 6 to 14 randomly-selected characters, same as for v3-01.
I had previously written a [PHP cleaner](/clean-php) that parsed PHP source code,
then pretty-printed it while replacing all variable names with the string `variable`,
function names with the string `function`, class names with `classname`, etc etc.
The resulting code does not retain the semantics of the original
- it probably does not execute correctly
- but it does retain the "shape" of the original, possible obfuscated, PHP code.

Only one block of code makes the v3-01 backdoor different from v2-01 backdoors.


### The Initial Set of Plugins


--------------------------

14.193.87.77.in-addr.arpa	name = ef485.mirohost.net.

Non-authoritative answer:
Name:   ef485.mirohost.net
Address: 77.87.193.14


Authoritative answers can be found from:

% This is the RIPE Database query service.
% The objects are in RPSL format.
%
% The RIPE Database is subject to Terms and Conditions.
% See http://www.ripe.net/db/support/db-terms-conditions.pdf

% Note: this output has been filtered.
%       To receive output for a database update, use the "-B" flag.

% Information related to '77.87.192.0 - 77.87.199.255'

% Abuse contact for '77.87.192.0 - 77.87.199.255' is 'noc@mirohost.net'

inetnum:        77.87.192.0 - 77.87.199.255
netname:        MIROHOST
country:        UA
org:            ORG-IIL11-RIPE
admin-c:        MHCC
tech-c:         MHCC
status:         ASSIGNED PI
mnt-by:         RIPE-NCC-END-MNT
mnt-by:         MIROHOST-MNT
mnt-routes:     MIROHOST-MNT
mnt-domains:    MIROHOST-MNT
created:        2007-07-18T12:40:22Z
last-modified:  2016-04-14T08:57:16Z
source:         RIPE # Filtered

organisation:   ORG-IIL11-RIPE
org-name:       Internet Invest Ltd.
org-type:       LIR
address:        Gaidara st. 50
address:        01033
address:        Kyiv
address:        UKRAINE
phone:          +380442010102
fax-no:         +380442010100
admin-c:        MHCC
abuse-c:        MHCC
mnt-ref:        RIPE-NCC-HM-MNT
mnt-ref:        MIROHOST-MNT
mnt-by:         RIPE-NCC-HM-MNT
mnt-by:         MIROHOST-MNT
created:        2009-05-01T11:13:59Z
last-modified:  2017-10-30T14:37:48Z
source:         RIPE # Filtered

role:           Mirohost Network Coordination Center
address:        Internet Invest Ltd.
address:        50 Gaydara str., Kyiv, Ukraine, 01033
phone:          +380 44 2010102
fax-no:         +380 44 2010100
abuse-mailbox:  noc@mirohost.net
admin-c:        GSA-RIPE
admin-c:        RB30447-RIPE
admin-c:        PHSM-RIPE
admin-c:        VAKH-RIPE
tech-c:         GSA-RIPE
tech-c:         PHSM-RIPE
tech-c:         VAKH-RIPE
tech-c:         RB30447-RIPE
nic-hdl:        MHCC
mnt-by:         MIROHOST-MNT
created:        2011-10-05T13:23:46Z
last-modified:  2018-02-15T19:14:00Z
source:         RIPE # Filtered

% Information related to '77.87.193.0/24AS28907'

route:          77.87.193.0/24
descr:          Internet Invest Ltd.
descr:          Web hosting, datacenter and domain names registration in Ukraine
descr:          Hosting part
descr:          Kiev, Ukraine
org:            ORG-IIL11-RIPE
origin:         AS28907
mnt-by:         MIROHOST-MNT
created:        2013-12-08T22:56:02Z
last-modified:  2013-12-08T22:56:02Z
source:         RIPE # Filtered

organisation:   ORG-IIL11-RIPE
org-name:       Internet Invest Ltd.
org-type:       LIR
address:        Gaidara st. 50
address:        01033
address:        Kyiv
address:        UKRAINE
phone:          +380442010102
fax-no:         +380442010100
admin-c:        MHCC
abuse-c:        MHCC
mnt-ref:        RIPE-NCC-HM-MNT
mnt-ref:        MIROHOST-MNT
mnt-by:         RIPE-NCC-HM-MNT
mnt-by:         MIROHOST-MNT
created:        2009-05-01T11:13:59Z
last-modified:  2017-10-30T14:37:48Z
source:         RIPE # Filtered

% This query was served by the RIPE Database Query Service version 1.94 (WAGYU)

### Download

Attackers sent this code to a URL ending in `/wordpress/wp-content/plugins/wp-mobile-detector/cache/db.php`.
Apparently they thought they were sending PHP code to a WSO web shell for immediate execution.
The download includes HTTP parameters named "a" and "p1", where the "a" parameter has a value of "RC".
This is exactly what one would send to a WSO web shell for immediate eval.
The parameter named "p1" has PHP code in it.

The attackers set two HTTP cookies along with the download.

| Cookie Name                    | Cookie value                   |
|--------------------------------|--------------------------------|
|59c3080850e28cdb724eafd61e539b81|866fd58d77526c1bda8771b5b21d5b11|
|7a017e28704d15b0d8efe38606806610|7a017e28704d15b0d8efe38606806610|


The cookie name "59c3080850e28cdb724eafd61e539b81" is the MD5 hash of the string "www.stratigery.com",
the host name the attackers used to in URLs to access my WordPress honey pot.
The value of that cookie, "866fd58d77526c1bda8771b5b21d5b11",
is the MD5 hash of "nhzgrf", an extremely common password for WSO web shells.

That's all pretty standard.
The second cookie,
name and value of "7a017e28704d15b0d8efe38606806610",
has much more interest.
The string "7a017e28704d15b0d8efe38606806610" is the value of this PHP calculation:

    md5(md5('www.stratigery.com') . 'www.stratigery.com' . "salt1I*@#31RTds34+543sf");

`$_SERVER['HTTP_HOST']` had the value "www.stratigery.com",
allowing a WSO web shell with Vigilante Password Code injected to calculate the hash
used as cookie name and value.

This is coming from something that knows about the [Vigilante Malware Cleaner](/vigilante_suspected).
The attackers included that cookie and value because they believed that the WSO they thought they
were using had another layer of protection, the hash of the host name.

### Dropper


