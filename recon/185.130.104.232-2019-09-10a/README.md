# Access and Execution Check

PHP sent to a webshell for immediate eval.
Checks whether or not it can create a file,
and if it can add 5 to 6.

## Origin

The attacker(s) thought they were sending PHP code to an instance of WSO web shell.
All the stereotypical WSO HTTP parameters show up:

|Parameter|Value|
|-------------|---------------|
|charset|UTF-8|
|p2||
|c||
|p1|...code to eval|
|pass|t4c3PFr5|
|a|Php|
|p3||

The "a" parameter names the action that WSO will take upon receipt.
The attacker(s) wanted to run the "Php" action, which is usually reserved for
interactive PHP editing and evaluation via AJAX-style interaction with WSO.
Sometimes people use it like this, as an immediate evaluation backdoor.

These folks were thorough: they included empty parameters named "p2", "p3" and "c",
which WSO doesn't use during the "Php" action, but some other actions do use.

### IP Address 185.130.104.232

185.130.104.232 has DNS name mail.mbooking24.com

    inetnum:        185.130.104.0 - 185.130.104.255
    netname:        King-Servers
    country:        RU
    geoloc:         55.784105 37.712066
    created:        2016-10-10T03:05:06Z
    last-modified:  2018-02-27T07:39:03Z

Apparently, 185.130.104.232 is somewhere in Moscow:

    GeoIP Country Edition: RU, Russian Federation
    GeoIP City Edition, Rev 1: RU, 48, Moscow City, Moscow, 107023, 55.752201, 37.615601, 0, 0
    GeoIP ASNum Edition: AS14576 Hosting Solution Ltd.

mbooking24.com is apparently registered by a Russian registrar:

    Domain Name: MBOOKING24.COM
    Registry Domain ID: 2312826983_DOMAIN_COM-VRSN
    Registrar WHOIS Server: whois.reg.com
    Registrar URL: http://www.reg.ru
    Updated Date: 2018-09-21T20:37:54Z
    Creation Date: 2018-09-21T20:37:53Z
    Registry Expiry Date: 2019-09-21T20:37:53Z
    Registrar: REGISTRAR OF DOMAIN NAMES REG.RU LLC

## Analysis

It will be easier to show than just to tell:

    $path = "/jgkf";    
    function is__writable($path) {
        //echo $path."\n";
        $p = realpath($path);
        if(is_dir($p)){       
            $path = $p;
            return is__writable($path.uniqid(mt_rand()).".tmp");
        }
    /*
    if ($path{strlen($path)-1}=="/")
        return is__writable($path.uniqid(mt_rand()).".tmp");
    */
    
    
    /*
    if (file_exists($path)) {
        if (!($f = @fopen($path, "r+")))
            return false;
        fclose($f);
        return true;
    }
    */
    if (!($f = @fopen($path, "w")))
        return false;
    fputs($f, "test");
    fclose($f);
    //unlink($path);
    return true;
    }
    
    $a = 5;
    $b = 6;
    if(is__writable($path)){
        echo "result:".($a+$b);
    } else {
        echo "NO";
    }

Hard to read because of the vestigial commented-out code,
but it tries to find the canonical file name of `/jgkf`.
If that's a directory, it composes a random file name
with `/jgkf` as a prefix,
something like`/jgkf2230505295d78d69d32bb5.tmp`
It finds out if it can write the string "test" to that
file name.
If it can, it adds `$a` and `$b`, displaying the result.
If it can't, it displays the string "NO".

In a very roundabout way,
this code checks if it can write a file in the root directory.
Unless it's running on Windows, in which case it tries to write
to an illegal file name, I think.
It looks like some PHP get evaluated,
which probably means to check if the code got intercepted
by a fake WSO instance.
Almost certainly no honey pot would eval code sent to it,
the honey pot code would look for string patterns.
My honey pot works this way.
Arbitrary simple PHP code probably won't get executed by
a honey pot. The attacker(s) can send different values of
`$a` and `$b` with every download attempt,
foiling pattern recognition by a honey pot.

I don't understand using "/jgkf" as first a directory name,
then as prefix of a file which isn't in that directory.
I'm not sure the attacker(s) are getting back the answers
they want, which might be "can WSO write to / directory?"
or it might be "can WSO write a file to /jgkf, a directory?"
The code, and the commented-out fragments in it, look like
the attacker(s) want answers to the 2nd question,
but are getting answers to the first question.
