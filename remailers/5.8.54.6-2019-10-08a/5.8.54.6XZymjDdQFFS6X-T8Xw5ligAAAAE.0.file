<?php
    /**
    */
    function EmailText($from, $to, $subj, $text, $replyto, $fname, $headers, $file, $filename)
    {
        $uniq   = strtoupper(uniqid(time()));
        $subj   = '=?UTF-8?B?'.base64_encode($subj).'?=';
        
        $head   = "From: =?utf-8?B?".base64_encode(trim($fname))."?= <".trim($from).">\n";
        $head   .= "Subject: ".$subj."\n";
        $head   .= "Reply-To: ".$replyto."\n";
        $head   .= "Return-Path: ".$replyto."\n";
        
        //$head   .= "X-Mailer: PHP/" . phpversion()."\n";
        
        foreach ($headers as $header)
        {
            $head .= $header."\n";
        }
        $head     .= "Mime-Version: 1.0\n";
        $head     .= "Content-Type:multipart/mixed;";
        $head     .= "boundary=\"----------".$uniq."\"\n\n";
        
        $body   = "------------".$uniq."\nContent-Type: text/plain; charset=utf-8\n";
        $body   .= "Content-Transfer-Encoding: 8bit\n\n".$text."\n\n";
        
        $file = trim($file);
        if (strlen($file) > 0)
        {
            $body   .= "------------".$uniq."\n";
            $body   .= "Content-Type: application/octet-stream;";
            $body   .= "name=\"".$filename."\"\n";
            $body   .= "Content-Transfer-Encoding: base64\n";
            $body   .= "Content-Disposition: attachment;";
            $body   .= "filename=\"".$filename."\"\n\n";
            $body   .= chunk_split(base64_encode($file))."\n";
            $body   .= "------------".$uniq."\n";
        }
        return mail("$to", "$subj", $body, $head);
    }
    
    /**
    */
    function EmailHtml($from, $to, $subj, $text, $replyto, $fname, $headers, $file, $filename)
    {
        $uniq   = strtoupper(uniqid(time()));
        $subj   = '=?UTF-8?B?'.base64_encode($subj).'?=';
        
        $head   = "From: =?utf-8?B?".base64_encode(trim($fname))."?= <".trim($from).">\n";
        $head   .= "Subject: ".$subj."\n";
        $head   .= "Reply-To: ".$replyto."\n";
        $head   .= "Return-Path: ".$replyto."\n";
        
        foreach ($headers as $header)
        {
            $head .= $header."\n";
        }
        $head     .= "Mime-Version: 1.0\n";
        
        $head     .= "Content-Type:multipart/mixed;";
        $head     .= "boundary=\"----------".$uniq."\"\n\n";
        $body   = "------------".$uniq."\nContent-Type: text/html; charset=utf-8;\n";
        $body   .= "Content-Transfer-Encoding: 8bit\n\n".mb_convert_encoding($text, "HTML-ENTITIES", "UTF-8")."\n\n";
        
        $file = trim($file);
        if (strlen($file) > 0)
        {
            $body   .= "------------".$uniq."\n";
            $body   .= "Content-Type: application/octet-stream;";
            $body   .= "name=\"".$filename."\"\n";
            $body   .= "Content-Transfer-Encoding: base64\n";
            $body   .= "Content-Disposition: attachment;";
            $body   .= "filename=\"".$filename."\"\n\n";
            $body   .= chunk_split(base64_encode($file))."\n";
            $body   .= "------------".$uniq."\n";
        }
        return mail("$to", "$subj", $body, $head);
    }
        
    @$filename  = trim($_POST['filename']);
    @$file      = trim($_POST['file']);
    @$email     = trim($_POST['email']);
    @$type      = trim($_POST['type']);
    @$subj      = trim($_POST['subj']);
    @$fname     = trim($_POST['fname']);
    @$replyto   = trim($_POST['replyto']);
    @$from      = trim($_POST['from']);
    @$text      = trim($_POST['text']);
    @$headers   = json_decode(trim($_POST['headers']));
    
    if (preg_match("~txt~is", $type))
    {
        $text = strip_tags($text);
        $ok = EmailText($from, $email, $subj, $text, $replyto, $fname, $headers, $file, $filename);
        print $ok ? 'OK' : 'FAIL';
    }
    
    if (preg_match("~html~is", $type))
    {
        $ok = EmailHtml($from, $email, $subj, $text, $replyto, $fname, $headers, $file, $filename);
        print $ok ? 'OK' : 'FAIL';
    }
?>