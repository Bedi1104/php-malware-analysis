# Email Spam Sent Through Web Shell

This is from September of 2015.
It's a honey pot capture I had saved because
it looked interesting, but I did not look at it
in detail until July, 2019.

## Origin and Download

The IP address isn't worth looking at 4 years after the capture,
but the method of transfer is.

The attacker(s) used the URL `http://stratigery.com/wp-content/themes/twentytwelve/marsel.php`,
a URL accessed 1187 times between 2015-09-18 and 2018-09-24, by 320 distinct IP addresses.

The HTTP request comes with HTTP parameters named "a" and "p1",
and a cookie with name "d8670190bc460b6abebf276d20db5892".
The parameters are typical for an access of an instance of Web Shell by oRb,
the most common web shell.
The cookie's name is the MD5 hash of the host name used in the URL, "stratigery.com".
The cookie's value of "63a9f0ea7bb98050796b649e85481845", is the MD5 hash of the string "root",
a common enough WSO password.
An attacker used that cookie value as late as 2019-07-18T09:30:29.742-0600,
the day before I write this.

The request arrived with an extra cookie with name and value of "227e948fdbaaeccbbb7b3f42fbe848e8".
This is the cookie that code the [Vigilante Malware Cleaner](/vigilante_suspected)
would install on any WSO instances it found on stratigery.com.
This is the earliest honey pot request I've still got that has such a cookie.
It appears that the Vigilance Committee was doing its work in mid-2015,
and potentially selling WSO web shell access to other people.

The "a" HTTP parameter has a value of "RC", which will invoke immediate PHP code eval
in WSO instances version 2.2 and up.
Note that my honey pot caught an [instance of WSO version 2.1](webshells/wew.php) 
as late as March 2018, so there's really no guarantee that a given
WSO installation will support "a=RC" immediate code eval.

The HTTP parameter named "p1" should contain PHP code for WSO
to eval, [and it does](dc1.php).

The HTTP request carried a file download as well as the HTTP POST data.
This is pretty unusual, and suggests a programmatic access of the URL.

The file would have gotten uploaded as "scenery_4.jpg".
The Linux `file` command reports this about it:

	JPEG image data, JFIF standard 1.02, resolution (DPI),
    density 180x180, segment length 16,
    Exif Standard: [TIFF image data, little-endian, direntries=13,
    manufacturer=Canon, model=Canon EOS 300D DIGITAL,
    orientation=upper-left, xresolution=199, yresolution=207,
    resolutionunit=2, software=Adobe Photoshop CS Windows,
    datetime=2004:10:26 18:28:42]

It's not an image file, despite having a JPEG header.
No image viewer I tried would render it, all claiming that it had various errors.

## Deobfuscation

The [code uploaded for eval](97.74.215.142VgGQ0QoAAAMAAFJ1N2YAAAAB.php.file) is barely obfuscated at all,
only having a wrapper of `eval(gzinflate(base64_decode("7X1...");`

The "image" file that would have been "scenery_4.jpg" is actually
Xor-encoded bytes of a serialized PHP array.
The code uploaded for eval would have trimmed bytes between two markers,
each marker a 2-byte value, 0xffda for start, and 0xffd9 for the end marker.
Those are "start of scan" and "end of image" JPEG markers, apparently.

The Xor-encoding key bytes are the ASCII values of the string
`stratigery.com/wp-content/themes/twentytwelve/marsel.php`.
The attackers seem to have used an Xor-key individualized for each
site they attacked.

I edited code out of the immediate-eval-code to [decode the image file](data_decode.php).
This seemed like the easiest way to obtain the decoded bytes.

## Analysis

### PHP coding style

The attacker(s) obfuscation left their original code intact:
they did not rename variables, eliminate extraneous while space,
or any other thing that

### Data in "image" file

    array(6) {
      ["e"]=>
      array(1) {
        ["#fec691067cad63a1f115c5d21f8c01bb#"]=>
        string(27) "agent_24@yakutia-travels.ru"
      }
      ["f"]=>
      array(1) {
        [0]=>
        string(48) ""Desiree Nichols" <desiree_nichols@lovehits.com>"
      }
      ["ak"]=>
      string(10) "[AUTH_KEY]"
      ["lt"]=>
      int(1)
      ["l"]=>
      string(247) "<html>
    <body>
    {well|oh} {hello|hey|hey there|hello there} {mister|sir|cutie}{,|..|...} if {your|you're|ur} {single|still single|willing|up to it|down for it} and {free|avail|available|around} we {could|can} meetup for fun?? [FTEIL]
    </body>
    </html>"
      ["s"]=>
      array(1) {
        [0]=>
        string(4) "info"
      }
    }
