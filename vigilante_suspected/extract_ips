#!/bin/bash

find . -name '*php.file' | xargs grep -l '^eval(base64_decode("' |
while read FNAME
do
	# Find timestamp of original attack.
	PREFIX=$(echo $FNAME | sed 's/.php.file//')
	NEWFNAME=$( echo $PREFIX.*.scans )
	EPOCH=$( fgrep '[REQUEST_TIME]' $NEWFNAME | awk '{print $3}' )
	TIMESTAMP=$(date --date="@$EPOCH" '+%Y-%m-%d' )
	IP=$(basename $PREFIX | sed -e 's/[VWXY]..*$//')
	STUFF=$(whois $IP |  egrep '[Nn]et[Nn]ame:|[Rr]oute:|[Cc][Ii][Dd][Rr]:' | awk '{print $2}')
	echo $TIMESTAMP  $IP $STUFF
done | sort -k1.1 | uniq
