# Multi-install Campaign

A 12-HTTP-request, 53-second malware installation campaign,
that, if made against a previously-compromised WordPress site,
would have resulted in installation of a variant [WSO web shell](https://github.com/bediger4000/malware-phylogeny#example-web-shell-by-orb),
and a modified [leafmailer](leafmailer).

## IP Address 213.81.213.48

As far as my records go back (to 2009),
213.81.213.48 has never accessed my website or WordPress honey pot.

213.81.213.48 &rarr; stip-static-48.213-81-213.telecom.sk

stip-static-48.213-81-213.telecom.sk &rarr; 213.81.213.48

    inetnum:        213.81.213.0 - 213.81.213.255
    netname:        ST-POPBA213-NET
    descr:          Slovak Telekom
    country:        SK
    remarks:        In case of security problem notify abuse@telekom.sk
    mnt-by:         SK-TELECOM-MNT
    created:        2004-10-01T08:38:21Z
    last-modified:  2012-12-03T13:37:13Z
    route:          213.81.128.0/17
    descr:          routes from Slovak Telecom AS6855
    origin:         AS6855
    mnt-by:         SK-TELECOM-MNT
    created:        1970-01-01T00:00:00Z
    last-modified:  2012-12-05T13:43:42Z

### Remote OS and browser

[nmap](https://nmap.org/) and [p0f3](http://lcamtuf.coredump.cx/p0f3/#) (for the SYN packet)
[both](nmap.out) [agree](p0f.log) that 213.81.213.48 had a Linux computer running it.

This disagrees with the User Agent string that got sent with
all requests:

    Mozilla/5.0 (Windows NT 6.3; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/75.0.3770.80 Safari/537.36

`p0f3` doesn't find a good guess for OS for the SYN-ACK packet.

`nmap` thinks 213.81.213.48's clock isn't synced, that it's about -21m38s off.

<!--
Here are the "raw sig" parts of the p0f3 logging:
SYN:     raw_sig=4:53+11:0:1460:mss*10,5:mss,sok,ts,nop,ws:df,id+
SYN-ACK: raw_sig=4:64+0 :0:1460:mss*45,7:mss,sok,ts,nop,ws:df:0

There are other discrepancies too, like the uptime changing around,
and the CPU frequency varying. p0f3 is 5 years old at this time,
things have changed.
-->

accept-language `en-GB,en-US;q=0.9,en;q=0.8`? From Slovakia?

## Requests


| Timestamp  |Remote port number| URL   |
|----------------------------|-----:|:-------------------------------------|
|2019-06-08T08:16:01.808-0600|45702|/wordpress/wp-content/plugins/revslider/temp/update_extract/revslider/db.php|
|2019-06-08T08:16:08.030-0600|45708|/wordpress/wp-content/plugins/revslider/temp/update_extract/revslider/db.php|
|2019-06-08T08:16:13.426-0600|45707|/wordpress/wp-content/plugins/revslider/temp/update_extract/revslider/db.php|
|2019-06-08T08:16:16.868-0600|45709|/wordpress/wp-content/plugins/revslider/temp/update_extract/revslider/db.php|
|2019-06-08T08:16:19.308-0600|45709|/wordpress/wp-content/plugins/revslider/temp/update_extract/revslider/db.php|
|2019-06-08T08:16:31.713-0600|45712|/wordpress/wp-content/plugins/revslider/temp/update_extract/revslider/db.php|
|2019-06-08T08:16:41.546-0600|45716|/wordpress/wp-content/plugins/revslider/temp/update_extract/revslider/.readme.php|
|2019-06-08T08:16:54.875-0600|45718|/wordpress/wp-content/plugins/revslider/temp/update_extract/revslider/.readme.php|

45707 out-of-order, 45709 re-used no other re-use.

p0f SYN packets show more activity at first.

Connection: keepalive, but different ports?

| Timestamp                  | Cookie(s) | HTTP Params |
|----------------------------|-----------:|-------------:|
|2019-06-08T08:16:01.808-0600| none      |  none       |
|2019-06-08T08:16:08.030-0600| none      | pass=nhzgrf |
|2019-06-08T08:16:13.426-0600| WSO auth cookie | a=FilesMan, c=/var/www/html |
|2019-06-08T08:16:16.868-0600| WSO auth cookie | a=FilesMan, c=/var/www/ |
|2019-06-08T08:16:19.308-0600| WSO auth cookie | a=FilesMan, c=/var/www/html/wordpress/wp-content/plugins/revslider/temp/update_extract/revslider |
|2019-06-08T08:16:31.713-0600| WSO auth cookie | a=FilesMan, c=/var/www/html/, p1=uploadFile |
|2019-06-08T08:16:41.546-0600| WSO auth cookie | none |
|2019-06-08T08:16:54.875-0600| WSO auth cookie | a=FilesMAn, p=uploadFile, c=...|

All these accesses come with stereotypical WSO HTTP parameters.

First request retrieves the WSO login page,
second request sends "nhzgrf" a very common WSO password.
Requests 3, 4, 5 get director listings of 3 directories.
Request 6 uploads file `.readme.php`, a [modified WSO web shell]().
Request 7 is of that modified WSO instance.
Request 8 sends a file `lead.php`, a [hacked version of leafmailer]()

The "WSO auth cookie" consists of a cookie with the name `md5($_SERVER['HTTP_HOST')`,
and the corresponding value of the MD5 hash of the password.
In this case, `md5("stratigery.com")` and `md5("nhzgrf")`.

It looks like the attacker(s) thought they were using a previously installed WSO web shell.
They installed their own WSO web shell, `.readme.php`,
and thought they used that to download a leafmailer instance,
which they named `lead.php`.
The initial login (second HTTP request) to what they thought was a WSO shell named `db.php`
set a WSO login cookie, which got sent with every request after that,
and would have made a real `.readme.php` act as if a login had occurred.

### Request timing

Human or automatic?

Why get the login page first?
