# Further Evolution of backdoor v 2.0-1

Someone sent me the file `ee01fd9b.ico` via email.

This code claims to be version 2.0-1,
but it's different from the pastebin version
[version 2.0-1](https://pastebin.com/qUM2RubB).

## Deobfuscation

1. Run the original `ee01fd9b.ico` through a pretty printer, yielding  `f1.php`
2. `f1.php` ends up XOR-ing a long string with `__FILE__`, what PHP thinks is the name of the file it executes.
Luckily I got the name of the file, ".ee01fd9b.ico",
so `f1.php` has "__FILE__" replaced with ".ee01fd9b.ico",
and "eval" replaced with "print".
3. Invoke `php f1.php > dc1.php` to get rid of one layer of obfuscation.
4. Change "eval" to "print" in `dc1.php1, invoke `php dc1.php > dc2. php`
5. `dc2.php` has all variables names,
and non-PHP-builtin function names replaced with random-looking strings of lower-case letters.
Hand edit `dc2.php` into file `hd1.php`.
I found the pastebin version after I did this hand-editing,
I did not choose identical function names with respect to
the pastebin version.

## Analysis

This version has some changes relative to the pastebin 2.0-1 version.
It includes its own base64 decoding routine,
and plugins get appended to the backdoor file,
rather than living in a particular directory.

The programmer who updated 2.0-1 backdoor code introduced a bug.
The function `fr_GetHost()` in original 2.0-1 code looks like this:

    function fr_GetHost()
    {
        return strtolower(preg_replace('/^(www|ftp)\./i','',@$_SERVER['HTTP_HOST']));
    }

I'm not sure why, but this trims "www." and "ftp." prefixes from
the DNS name by which WSO gets invoked. It appears in the dropper code.

Because the programmer of this version changed where plugin code gets
stored, and stores it encoded with the DNS name,
they copied `fr_GetHost()` into the backdoor,
but goofed up the regular expression:

    function dhoxfz()
    {
        return trim(preg_replace("/\(.*\$/", '', __FILE__));
    }

This code just eliminates any suffix of a file name that begins with a '('
(left parentheses) character.
Such filenames exist, but I don't see them often.
I can't imagine this is what the programmer intended.
Function `dhoxfz()` (from [randomly-renamed-strings backdoor](dc2.php))
doesn't do much,
but gets executed a lot.
