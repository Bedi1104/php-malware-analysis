#!/bin/bash

DST=intermediate1
DST2=intermediate2
DST3=final
SRC=files

rm -rf $DST
mkdir $DST

for FNAME in $SRC/*.php.file
do
	IP=$(basename $FNAME | sed 's/W..*$//')
	#echo $FNAME $IP
	echo '<?php' > $DST/$IP
	fgrep payload_file $FNAME | sed '2d' >> $DST/$IP
	if fgrep -q '%20' $DST/$IP
	then
		echo 'print(rawurldecode($payload_file));' >> $DST/$IP
	else
		echo 'print(base64_decode($payload_file));' >> $DST/$IP
	fi
done

rm -rf $DST2
mkdir $DST2

for FNAME in $DST/*
do
	IP=$(basename $FNAME)
	echo '<?php' > $DST2/$IP
	php $FNAME | sed 's/eval/print/' >> $DST2/$IP
done


rm -rf $DST3
mkdir $DST3

for FNAME in $DST2/*
do
	IP=$(basename $FNAME)
	/home/bediger/src/php/reverse-php-malware/revphp $FNAME > $DST3/$IP
done

exit
