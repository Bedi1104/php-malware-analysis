# Deobfuscation

3 batches of files, each batch has a different obfuscation method

1. `files/*` - WSO 2.x, unknown web shell downloads
2. `files2/*` - WSO 4.x download - xor of base64-encoded obfuscation
3. `files3/*` - same unknown web shell, another layer of obfuscation


## Deobfuscate batch 1

1. `files/*` -> editem -> `base64/*`
2. `base64/*` -> create_dropper -> `phpdroppers/*`
3. `phpdroppers/*` -> create_pl -> `pl/*` - daemons
4. `pl/*` -> create_persistent -> `uuencoded/*`
5. `uuencoded/*` -> create_pl2 -> `pl2/*` - persistent payloads

## Deobfuscate batch 2

1. `files2/*.php.file` -> create_pl2_2 -> `pl2_2/*`
2. `pl2_2/*` -> create_pl3_2 -> `pl3_2/*`  # daemon code
3. `pl3_2/*` -> create_persistent3 -> `uuencoded2/*`  # uuencoded
4. `uuencoded2/*` -> create_pl3x -> pl2/<new files>

## Deobfuscate batch 3

Batch 3 has an extra layer of base64 obfuscation on it.

Also, 4 of the files have a modified daemon,
one that doesn't contain or drop the persistent payload.

1. `files3/*wso.scans` -> create_dropper3 -> `droppers3/*`
2. `droppers3/*` -> create_pl3 -> `pl3/*` 
Files in `pl3/` are analogous to files in `phpdroppers/`,
but there's more extraneous PHP on them.
3. `pl3/*` -> create_pl4 -> `pl4/*`
4. `pl4/*` -> create_pl5 -> `pl5/*`  Just base64 decoding
Files in `pl5/` analogous to files in 'pl/*' - daemon code
Four of the files in `pl5/` have no uuencoded payload.
5. `pl5/*` -> create_persistent2 -> `uuencoded3/*`
6. `uuencoded3/*` -> create_pl2x -> `pl2/<new files>`

## Deobfuscate batch 4

These files are similar to batch 1 files,
but they've been XOR'ed.

The files in `files4/` also derive from WSO 4.x downloads.
They have a different wrapper,
so I did not understand them as mumblehard downloads
when I worked on batch 2.

I wrote one script `extract4`, to do the deobfuscation,
since I have more experience with mumblehard downloads.

1. `files4/*` -> remove extraneous PHP -> `intermediate4.1/*`
2. `php intermediate4.1/*` -> `intermediate4.2/*`
3. `php intermediate4.2/*` -> add "print" statements -> `intermediate4.3/*` PHP dropper, analogous to `phpdroppers/*`
4. `php intermediate4.3/*` -> `intermediate4.4/*` roughly like `pl/*`, Perl daemon code
5. `intermediate4.4/*` -> extra uuencoded chunk -> `intermediate4.5/*.uu`
5. `intermediate4.4/*.uu` -> uudecode chunk -> `intermediate4.5/*`

